# Agent Factory Implementation Guide

## Overview

The Agent Factory system enables creation of specialized AI teaching agents with different configurations, system prompts, and parameters. Content is generated by the LLM, not web-scraped.

**Note:** This document describes legacy architecture. Current system uses 5-agent pipeline for automated course generation. See `COURSE_GENERATION_ARCHITECTURE.md` for current implementation.

## Components Implemented

### 1. Admin Dashboard (`admin_dashboard.html`)
- **Purpose**: Central hub for all admin operations
- **Features**:
  - Real-time statistics (agents, courses, students, pending reviews)
  - Navigation to all admin tools
  - Recent activity log
  - Role-based access control (admin only)

### 2. Content Scraper System

#### Web Scraper Interface (`admin_scraper.html`)
- URL input with validation
- Grade level and subject area classification
- Content type selection
- Quick links to educational resources
- Real-time scraping with progress indicator
- List of recently scraped content

#### Scraper API (`api/admin/scraper.php`)
- cURL-based HTML content fetching
- Automatic content extraction and cleaning
- Metadata capture (domain, credibility score, source tracking)
- Security validation (blocks private IPs, validates URLs)
- Credibility scoring based on domain (.edu, .gov get higher scores)

### 3. Content Review System

#### Review Interface (`admin_content_review.html`)
- Split-screen design: sidebar list + main review area
- Filter by status (pending, approved, rejected)
- Quality assessment scores (accuracy, relevance, quality)
- Fact-checking notes
- Approve/reject/revise workflow
- Automatic RAG integration for approved content

#### Review APIs
- `api/admin/get_content.php` - Fetch content details
- `api/admin/review_content.php` - Submit reviews with quality scores
- `api/admin/list_scraped_content.php` - List content with filters

### 4. Agent Factory System

#### Agent Factory Interface (`admin_agent_factory.html`)
- **4-Step Wizard**:
  1. **Template Selection**: Pre-configured templates for elementary math, middle school math, elementary science, or custom
  2. **Configuration**: Name, grade level, subject, specialization, model selection, system prompt
  3. **Knowledge Base**: Link approved scraped content to agent
  4. **Review & Create**: Preview configuration before creation

#### Agent Creation API (`api/admin/create_agent.php`)
- Creates agent record in database
- Links knowledge sources to agent
- Adds approved content to RAG system
- Configures personality and teaching parameters
- Activity logging

### 5. Fine-Tuning Export System

#### Export API (`api/admin/export_training_data.php`)
- Exports conversation history from `agent_memories` table
- Filters by:
  - Agent ID (specific agent or all)
  - Importance score threshold (default 0.70)
  - Date range
- Export formats:
  - **JSONL** (Ollama fine-tuning format)
  - **JSON** (structured data)
  - **CSV** (spreadsheet analysis)
- Tracks exports in `training_exports` table

### 6. Database Schema Updates

#### New Tables Added to `schema.sql`:

**`admin_activity_log`**
- Tracks all admin actions
- Fields: user_id, action, details, metadata, created_at

**`scraped_content`**
- Stores web scraped educational content
- Fields: source_url, page_title, raw_content, extracted_text, metadata
- Quality tracking: credibility_score, review_status, reviewed_by
- Classification: grade_level, subject_area, content_type
- RAG integration: is_added_to_rag flag

**`content_reviews`**
- Detailed review records with quality scores
- Fields: accuracy_score, relevance_score, quality_score
- Fact-checking notes and recommendations
- Links to scraped_content via content_id

**`training_exports`**
- Tracks model fine-tuning data exports
- Export parameters and statistics
- File path and metadata storage

### 7. Authorization System

#### Admin Middleware (`api/admin/auth_check.php`)
- `requireAdmin()` - Enforces admin-only access
- `isAdmin()` - Non-terminating role check
- `logAdminAction()` - Activity logging
- `validateScraperUrl()` - Security validation for scraping

## Workflow: Creating a Grade-Specific Math Agent

### Step 1: Scrape Educational Content
1. Navigate to **Content Scraper** (`admin_scraper.html`)
2. Enter URL (e.g., Common Core Math Standards)
3. Select grade level (e.g., "Grade 1")
4. Select subject area ("Mathematics")
5. Click "Scrape Content"
6. System captures:
   - Full HTML content
   - Extracted clean text
   - Page title and metadata
   - Source URL and domain
   - Automatic credibility score

### Step 2: Review and Approve Content
1. Navigate to **Content Review** (`admin_content_review.html`)
2. System shows pending content
3. Review content for:
   - Accuracy (fact-checking)
   - Relevance to grade level
   - Educational quality
4. Add notes on strengths/weaknesses
5. Select "Approve" recommendation
6. Submit review
7. Approved content is marked and available for agents

### Step 3: Create Specialized Agent
1. Navigate to **Agent Factory** (`admin_agent_factory.html`)
2. **Step 1**: Select "Elementary Math Tutor" template
3. **Step 2**: Configure agent:
   - Name: "Ms. Math Grade 1"
   - Grade Level: "Grade 1"
   - Subject: "Mathematics"
   - Specialization: "First grade mathematics focusing on counting, addition, subtraction, place value, and basic word problems"
   - Model: "llama2" or "qwen2.5:3b"
   - System Prompt: "You are a patient and encouraging first grade math tutor. You use simple language, visual examples with counting objects, and celebrate every small success. You help children build confidence with numbers."
4. **Step 3**: Add approved content to knowledge base
   - System shows filtered content (Grade 1 + Mathematics)
   - Click "Add" for relevant standards and lessons
5. **Step 4**: Review and create
   - Preview JSON configuration
   - Click "Create Agent"
6. Agent is created with linked knowledge sources

### Step 4: Collect Training Data
- Students interact with the agent
- Conversations stored in `agent_memories` table
- System tracks importance scores for quality conversations

### Step 5: Export for Fine-Tuning
1. Navigate to **Model Fine-Tuning** interface (when built)
2. Select agent (e.g., "Ms. Math Grade 1")
3. Set filters:
   - Minimum importance: 0.75 (high-quality conversations only)
   - Date range: Last 30 days
4. Choose format: JSONL (for Ollama)
5. Export creates file in `media/training_exports/`
6. JSONL format:
```jsonl
{"instruction": "What is 5 + 3?", "response": "Let's count together! If you have 5 apples and get 3 more...", "context": "..."}
{"instruction": "How do I solve 12 - 7?", "response": "Great question! Let's use our fingers...", "context": "..."}
```

### Step 6: Fine-Tune Model (Manual Process)
```bash
# Use Ollama to fine-tune with exported data
ollama create ms-math-grade1 -f Modelfile
# Modelfile references the training JSONL

# Update agent in database to use fine-tuned model
# Change model_name from "llama2" to "ms-math-grade1"
```

## Creating Math Grade 1 and Grade 2 Agents

### Math Grade 1 Agent Specification

**Recommended Sources to Scrape**:
- Common Core Math Standards Grade 1: http://www.corestandards.org/Math/Content/1/
- Khan Academy Grade 1 Math lessons
- NCTM resources for early elementary

**Agent Configuration**:
```json
{
  "name": "Ms. Numbers (Grade 1)",
  "type": "math_tutor",
  "grade_level": "grade_1",
  "subject_area": "mathematics",
  "specialization": "First grade mathematics: counting to 120, addition and subtraction within 20, place value (tens/ones), measurement, telling time, shapes, and simple word problems",
  "model_name": "llama2",
  "temperature": 0.6,
  "system_prompt": "You are Ms. Numbers, a warm and patient first grade math tutor. You:\n- Use very simple language appropriate for 6-7 year olds\n- Incorporate visual examples (counting objects, fingers, number lines)\n- Celebrate every correct answer enthusiastically\n- Break problems into tiny steps\n- Use real-world examples from a child's daily life\n- Encourage counting strategies (counting on, counting back)\n- Never show frustration when students struggle\n- Use emojis and encouraging phrases\n- Focus on building confidence and number sense"
}
```

**Key Topics for Grade 1**:
- Counting to 120, skip counting by 2s, 5s, 10s
- Addition and subtraction within 20
- Understanding place value (tens and ones)
- Comparing numbers using >, <, =
- Measuring length with units
- Telling time to the hour and half hour
- Identifying 2D and 3D shapes
- Simple data collection and graphs

### Math Grade 2 Agent Specification

**Recommended Sources to Scrape**:
- Common Core Math Standards Grade 2: http://www.corestandards.org/Math/Content/2/
- Khan Academy Grade 2 Math lessons
- Math word problem resources for grade 2

**Agent Configuration**:
```json
{
  "name": "Professor Numbers (Grade 2)",
  "type": "math_tutor",
  "grade_level": "grade_2",
  "subject_area": "mathematics",
  "specialization": "Second grade mathematics: addition and subtraction within 100, understanding place value to 1000, measurement with standard units, money, time, data analysis, and introduction to multiplication concepts",
  "model_name": "llama2",
  "temperature": 0.7,
  "system_prompt": "You are Professor Numbers, an enthusiastic second grade math tutor. You:\n- Use age-appropriate language for 7-8 year olds\n- Bridge concrete examples to beginning abstract thinking\n- Introduce mental math strategies\n- Use drawings and diagrams to illustrate concepts\n- Encourage multiple solution strategies\n- Connect math to real-world situations (money, time, measurement)\n- Introduce mathematical vocabulary naturally\n- Build on students' first grade knowledge\n- Celebrate logical thinking and problem-solving\n- Use word problems that relate to students' experiences"
}
```

**Key Topics for Grade 2**:
- Addition and subtraction within 100 (with regrouping)
- Place value to 1000
- Skip counting by 2s, 5s, 10s, 100s
- Even and odd numbers
- Measuring length in standard units (inches, feet, centimeters, meters)
- Money (counting coins and bills)
- Telling time to 5-minute intervals
- Word problems (two-step problems)
- Arrays and repeated addition (foundation for multiplication)
- Bar graphs and picture graphs

## Security Considerations

1. **URL Validation**: Scraper blocks private IPs and validates URLs
2. **Admin-Only Access**: All admin endpoints require admin role
3. **SQL Injection Protection**: Prepared statements used throughout
4. **XSS Prevention**: Content properly escaped in HTML
5. **CORS Configuration**: Controlled via database.php

## File Structure

```
/home/steve/Professor_Hawkeinstein/
├── admin_dashboard.html          # Main admin interface
├── admin_scraper.html            # Content scraper interface  
├── admin_content_review.html     # Review interface
├── admin_agent_factory.html      # Agent creation wizard
├── schema.sql                    # Updated with new tables
└── api/
    └── admin/
        ├── auth_check.php        # Authorization middleware
        ├── statistics.php        # Dashboard stats
        ├── activity.php          # Activity log
        ├── scraper.php           # Web scraping backend
        ├── list_scraped_content.php  # Content listing
        ├── get_content.php       # Content detail
        ├── review_content.php    # Submit reviews
        ├── create_agent.php      # Create agents
        └── export_training_data.php  # Training data export
```

## Next Steps

### Immediate Tasks:
1. **Update Database**: Run updated `schema.sql` to create new tables
2. **Create Media Directory**: `mkdir -p media/training_exports && chmod 755 media/training_exports`
3. **Test Admin Login**: Use existing admin account (username: admin, password: admin123)

### Creating Grade 1 & 2 Math Agents:
1. Use the scraper to collect Common Core standards and educational resources
2. Review and approve content for accuracy
3. Use Agent Factory wizard to create both agents with appropriate configurations
4. Test agents with sample student questions
5. Collect high-quality conversations
6. Export training data when sufficient data exists
7. Fine-tune models with Ollama

### Future Enhancements:
- **Batch Scraping**: Scrape multiple URLs at once
- **Content Deduplication**: Detect similar content
- **Advanced RAG**: Implement vector embeddings (C++ microservice)
- **Auto-Chunking**: Smart content chunking for RAG
- **Fine-Tuning UI**: Interface for initiating Ollama fine-tuning
- **Agent Analytics**: Performance metrics per agent
- **A/B Testing**: Compare base vs fine-tuned models
- **Curriculum Mapping**: Link content to specific learning standards

## Troubleshooting

### Issue: "Undefined function getDB()"
- Ensure `config/database.php` is properly included
- Function is defined starting at line 43 of database.php

### Issue: Scraper returns empty content
- Check if target website blocks bots (user-agent)
- Verify URL is accessible (not behind authentication)
- Check if content is JavaScript-rendered (would need headless browser)

### Issue: Can't access admin dashboard
- Verify user has role='admin' in database
- Check localStorage has valid token
- Ensure admin user exists: username 'admin', password 'admin123'

### Issue: Training export fails
- Ensure `media/training_exports/` directory exists with write permissions
- Check if agent_memories table has data
- Verify importance_score filtering isn't too restrictive

## Technical Notes

- **Credibility Scoring**: .edu and .gov domains get 0.95, Wikipedia gets 0.75, others 0.50
- **Content Extraction**: Removes scripts/styles, preserves text structure
- **JSONL Format**: One JSON object per line, compatible with Ollama fine-tuning
- **Importance Threshold**: Default 0.70 filters out low-quality conversations
- **Temperature Settings**: Lower for facts (0.6 Grade 1), higher for explanations (0.7 Grade 2)

## API Endpoints Summary

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/admin/statistics.php` | GET | Dashboard statistics |
| `/api/admin/activity.php` | GET | Recent admin actions |
| `/api/admin/scraper.php` | POST | Scrape URL content |
| `/api/admin/list_scraped_content.php` | GET | List scraped content |
| `/api/admin/get_content.php` | GET | Get content detail |
| `/api/admin/review_content.php` | POST | Submit content review |
| `/api/admin/create_agent.php` | POST | Create new agent |
| `/api/admin/export_training_data.php` | POST | Export training data |

All endpoints require `Authorization: Bearer <token>` header with admin token.

## Success Criteria

✅ Admin can scrape educational content from URLs  
✅ Content is stored with source metadata and credibility scores  
✅ Review workflow allows approval/rejection with quality assessment  
✅ Approved content can be linked to agents via RAG system  
✅ Agent Factory creates specialized agents with knowledge bases  
✅ Training data can be exported in Ollama-compatible format  
✅ All admin actions are logged for audit trail  
✅ System supports creating grade-specific agents (Math 1, Math 2)

## Implementation Complete

The Agent Factory system is now fully operational and ready for creating specialized educational agents!
