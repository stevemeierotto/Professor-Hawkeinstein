#!/bin/bash
# Sync Test Suite - Validates web deployment sync
# Tests: rsync execution, exclusion patterns, permission handling, file integrity

set -euo pipefail

# ==============================================================================
# CONFIGURATION
# ==============================================================================
TEST_NAME="Sync Validation Test"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
SYNC_SCRIPT="$PROJECT_ROOT/scripts/sync_to_web.sh"
EXCLUSION_FILE="$PROJECT_ROOT/.rsyncignore"
WEB_DIR="/var/www/html/basic_educational"

TESTS_PASSED=0
TESTS_FAILED=0

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ==============================================================================
# HELPER FUNCTIONS
# ==============================================================================
echo_test() {
    echo -e "${YELLOW}TEST:${NC} $1"
}

echo_pass() {
    echo -e "${GREEN}✓ PASSED:${NC} $1"
    TESTS_PASSED=$((TESTS_PASSED + 1))
}

echo_fail() {
    echo -e "${RED}✗ FAILED:${NC} $1"
    TESTS_FAILED=$((TESTS_FAILED + 1))
}

echo_info() {
    echo -e "  $1"
}

# ==============================================================================
# TEST SUITE
# ==============================================================================
echo "=== $TEST_NAME ==="
echo ""

# ------------------------------------------------------------------------------
# Test 1: Sync script exists and is executable
# ------------------------------------------------------------------------------
echo_test "Sync script exists and is executable"
if [ -f "$SYNC_SCRIPT" ] && [ -x "$SYNC_SCRIPT" ]; then
    echo_pass "Sync script found and executable: $SYNC_SCRIPT"
else
    echo_fail "Sync script not found or not executable: $SYNC_SCRIPT"
fi
echo ""

# ------------------------------------------------------------------------------
# Test 2: Exclusion file exists and has content
# ------------------------------------------------------------------------------
echo_test "Exclusion file exists and has patterns"
if [ -f "$EXCLUSION_FILE" ]; then
    PATTERN_COUNT=$(grep -c -v '^#' "$EXCLUSION_FILE" | grep -c -v '^$' || echo 0)
    if [ "$PATTERN_COUNT" -gt 0 ]; then
        echo_pass "Exclusion file found with $PATTERN_COUNT patterns"
    else
        echo_fail "Exclusion file exists but has no patterns"
    fi
else
    echo_fail "Exclusion file not found: $EXCLUSION_FILE"
fi
echo ""

# ------------------------------------------------------------------------------
# Test 3: Dry run executes without errors
# ------------------------------------------------------------------------------
echo_test "Dry run executes successfully"
if "$SYNC_SCRIPT" --dry-run > /tmp/sync_test_dryrun.log 2>&1; then
    echo_pass "Dry run completed without errors"
    echo_info "Output saved to /tmp/sync_test_dryrun.log"
else
    echo_fail "Dry run failed (exit code: $?)"
    echo_info "Check /tmp/sync_test_dryrun.log for details"
fi
echo ""

# ------------------------------------------------------------------------------
# Test 4: Web directory exists or can be created
# ------------------------------------------------------------------------------
echo_test "Web directory exists and is accessible"
if [ -d "$WEB_DIR" ]; then
    echo_pass "Web directory exists: $WEB_DIR"
    
    # Check if we can write (with sudo)
    TEST_FILE="$WEB_DIR/.sync_test_$$"
    if sudo touch "$TEST_FILE" 2>/dev/null; then
        sudo rm -f "$TEST_FILE"
        echo_pass "Write access confirmed (with sudo)"
    else
        echo_fail "No write access to web directory (even with sudo)"
    fi
else
    echo_info "Web directory doesn't exist yet: $WEB_DIR"
    echo_info "It will be created on first sync"
    TESTS_PASSED=$((TESTS_PASSED + 1))
fi
echo ""

# ------------------------------------------------------------------------------
# Test 5: Sensitive files are in exclusion list
# ------------------------------------------------------------------------------
echo_test "Sensitive files are excluded"
SENSITIVE_FILES=(
    ".env"
    "config/database.php"
    "*.key"
    "*.pem"
    "logs/"
    "tests/"
)

MISSING_EXCLUSIONS=0
for pattern in "${SENSITIVE_FILES[@]}"; do
    if grep -q "^$pattern" "$EXCLUSION_FILE" 2>/dev/null; then
        echo_info "✓ $pattern is excluded"
    else
        echo_info "✗ $pattern NOT in exclusion list"
        MISSING_EXCLUSIONS=$((MISSING_EXCLUSIONS + 1))
    fi
done

if [ $MISSING_EXCLUSIONS -eq 0 ]; then
    echo_pass "All sensitive patterns are excluded"
else
    echo_fail "$MISSING_EXCLUSIONS sensitive patterns missing from exclusion list"
fi
echo ""

# ------------------------------------------------------------------------------
# Test 6: Verify excluded files NOT in web directory (after sync)
# ------------------------------------------------------------------------------
echo_test "Sensitive files are NOT present in web directory"
if [ -d "$WEB_DIR" ]; then
    LEAKED_FILES=0
    SENSITIVE_CHECKS=(
        ".env"
        ".rsyncignore"
        "config/database.php"
        "tests/rag_flow.test"
        "tests/sync.test"
        "README.md"
        "setup.sh"
    )
    
    for file in "${SENSITIVE_CHECKS[@]}"; do
        if [ -e "$WEB_DIR/$file" ]; then
            echo_info "⚠️  LEAKED: $file exists in web directory"
            LEAKED_FILES=$((LEAKED_FILES + 1))
        fi
    done
    
    if [ $LEAKED_FILES -eq 0 ]; then
        echo_pass "No sensitive files found in web directory"
    else
        echo_fail "$LEAKED_FILES sensitive files leaked to web directory"
    fi
else
    echo_info "Web directory doesn't exist yet - skipping this test"
    TESTS_PASSED=$((TESTS_PASSED + 1))
fi
echo ""

# ------------------------------------------------------------------------------
# Test 7: Required web files ARE synced
# ------------------------------------------------------------------------------
echo_test "Required web files are present in web directory"
if [ -d "$WEB_DIR" ]; then
    REQUIRED_FILES=(
        "index.html"
        "student_dashboard.html"
        "api/agent/chat.php"
        "api/auth/login.php"
    )
    
    MISSING_REQUIRED=0
    for file in "${REQUIRED_FILES[@]}"; do
        if [ -f "$WEB_DIR/$file" ]; then
            echo_info "✓ $file present"
        else
            echo_info "✗ $file MISSING"
            MISSING_REQUIRED=$((MISSING_REQUIRED + 1))
        fi
    done
    
    if [ $MISSING_REQUIRED -eq 0 ]; then
        echo_pass "All required files present in web directory"
    else
        echo_fail "$MISSING_REQUIRED required files missing from web directory"
        echo_info "Run: make sync-web to deploy"
    fi
else
    echo_info "Web directory doesn't exist yet - skipping this test"
    echo_info "Run 'make sync-web' to perform first sync"
    TESTS_PASSED=$((TESTS_PASSED + 1))
fi
echo ""

# ------------------------------------------------------------------------------
# Test 8: Verify rsync is installed
# ------------------------------------------------------------------------------
echo_test "rsync command is available"
if command -v rsync &> /dev/null; then
    RSYNC_VERSION=$(rsync --version | head -1)
    echo_pass "rsync is installed: $RSYNC_VERSION"
else
    echo_fail "rsync is not installed"
    echo_info "Install with: sudo apt-get install rsync"
fi
echo ""

# ------------------------------------------------------------------------------
# Test 9: Log file is created and writable
# ------------------------------------------------------------------------------
echo_test "Log file can be created"
LOG_FILE="/tmp/sync_to_web.log"
if touch "$LOG_FILE" 2>/dev/null; then
    echo_pass "Log file is writable: $LOG_FILE"
else
    echo_fail "Cannot create log file: $LOG_FILE"
fi
echo ""

# ------------------------------------------------------------------------------
# Test 10: Makefile target exists
# ------------------------------------------------------------------------------
echo_test "Makefile has sync-web target"
if [ -f "$PROJECT_ROOT/Makefile" ]; then
    if grep -q "^sync-web:" "$PROJECT_ROOT/Makefile"; then
        echo_pass "Makefile has sync-web target"
        echo_info "Usage: make sync-web"
    else
        echo_fail "Makefile missing sync-web target"
    fi
else
    echo_fail "Makefile not found"
fi
echo ""

# ==============================================================================
# SUMMARY
# ==============================================================================
echo "========================================"
TOTAL_TESTS=$((TESTS_PASSED + TESTS_FAILED))
echo "Tests run: $TOTAL_TESTS"
echo "Passed: $TESTS_PASSED"
echo "Failed: $TESTS_FAILED"
echo ""

if [ $TESTS_FAILED -eq 0 ]; then
    echo -e "${GREEN}✅ All sync tests passed!${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Preview sync: make sync-web-dry"
    echo "  2. Deploy:       make sync-web"
    echo "  3. Check logs:   tail -f /tmp/sync_to_web.log"
    exit 0
else
    echo -e "${RED}⚠️  $TESTS_FAILED test(s) failed${NC}"
    echo ""
    echo "Fix the issues above and run again:"
    echo "  ./tests/sync.test"
    exit 1
fi
