#!/bin/bash
# RAG Flow End-to-End Test
# Tests: Scrape → Embed → Retrieve → Chat pipeline

set -e

TEST_NAME="RAG Flow Test"
PROJECT_ROOT="/home/steve/Professor_Hawkeinstein"
API_BASE="http://localhost/basic_educational/api"
ADMIN_TOKEN=""
TEST_CONTENT_ID=""

echo "=== $TEST_NAME ==="
echo "Testing complete RAG pipeline from content ingestion to chat"
echo

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

function pass() {
    echo -e "${GREEN}✓ PASSED:${NC} $1"
}

function fail() {
    echo -e "${RED}✗ FAILED:${NC} $1"
    exit 1
}

function info() {
    echo -e "${YELLOW}ℹ INFO:${NC} $1"
}

# Step 1: Apply migration
echo "Step 1: Apply RAG embeddings migration"
mysql -u professorhawkeinstein_user -pBT1716lit professorhawkeinstein_platform < "$PROJECT_ROOT/migrations/add_rag_embeddings.sql" 2>&1 | grep -v "Warning" || true
pass "Migration applied"
echo

# Step 2: Check if test content exists
echo "Step 2: Check for test content"
CONTENT_CHECK=$(mysql -u professorhawkeinstein_user -pBT1716lit professorhawkeinstein_platform -se "SELECT content_id FROM scraped_content LIMIT 1" 2>/dev/null)

if [ -z "$CONTENT_CHECK" ]; then
    info "No scraped content found. Creating test content..."
    
    # Insert test content
    mysql -u professorhawkeinstein_user -pBT1716lit professorhawkeinstein_platform << 'EOSQL'
INSERT INTO scraped_content (url, title, subject, grade_level, content_text, content_html, scraped_by, review_status)
VALUES (
    'http://test.local/test',
    'Mathematics - Addition and Subtraction',
    'Mathematics',
    'grade_1',
    'Addition is combining two or more numbers together. For example, 2 + 3 = 5. Subtraction is taking away one number from another. For example, 5 - 2 = 3. These are fundamental operations in mathematics that students learn in first grade.',
    '<p>Addition is combining two or more numbers together. For example, 2 + 3 = 5.</p><p>Subtraction is taking away one number from another. For example, 5 - 2 = 3.</p>',
    1,
    'approved'
);
EOSQL
    
    TEST_CONTENT_ID=$(mysql -u professorhawkeinstein_user -pBT1716lit professorhawkeinstein_platform -se "SELECT LAST_INSERT_ID()" 2>/dev/null)
    pass "Test content created (ID: $TEST_CONTENT_ID)"
else
    TEST_CONTENT_ID=$CONTENT_CHECK
    pass "Using existing content (ID: $TEST_CONTENT_ID)"
fi
echo

# Step 3: Generate embeddings for content
echo "Step 3: Generate embeddings for content"
info "Content ID: $TEST_CONTENT_ID"

# Create a simple PHP script to generate embeddings
php -r "
require_once '$PROJECT_ROOT/api/helpers/embedding_generator.php';
require_once '$PROJECT_ROOT/config/database.php';

\$db = getDB();
\$generator = new EmbeddingGenerator();

// Get content
\$stmt = \$db->prepare('SELECT content_text FROM scraped_content WHERE content_id = ?');
\$stmt->execute([$TEST_CONTENT_ID]);
\$content = \$stmt->fetch();

if (!\$content) {
    echo 'Content not found\n';
    exit(1);
}

// Generate embeddings
\$chunks = \$generator->chunkText(\$content['content_text'], 500, 50);
echo 'Chunks generated: ' . count(\$chunks) . '\n';

\$db->beginTransaction();
\$insertStmt = \$db->prepare('
    INSERT INTO content_embeddings (content_id, chunk_index, text_chunk, embedding_vector, vector_dimension, model_used)
    VALUES (?, ?, ?, ?, ?, ?)
');

foreach (\$chunks as \$index => \$chunk) {
    \$embedding = \$generator->generateEmbedding(\$chunk);
    \$blob = \$generator->serializeEmbedding(\$embedding);
    \$insertStmt->execute([$TEST_CONTENT_ID, \$index, \$chunk, \$blob, 384, 'all-MiniLM-L6-v2']);
}

// Update scraped_content
\$updateStmt = \$db->prepare('UPDATE scraped_content SET has_embeddings = TRUE, embedding_count = ? WHERE content_id = ?');
\$updateStmt->execute([count(\$chunks), $TEST_CONTENT_ID]);

\$db->commit();
echo 'Embeddings stored: ' . count(\$chunks) . '\n';
"

if [ $? -eq 0 ]; then
    pass "Embeddings generated successfully"
else
    fail "Embedding generation failed"
fi
echo

# Step 4: Test context retrieval
echo "Step 4: Test context retrieval"
QUERY="What is addition?"

RETRIEVE_RESULT=$(php -r "
require_once '$PROJECT_ROOT/api/helpers/embedding_generator.php';
require_once '$PROJECT_ROOT/config/database.php';

\$db = getDB();
\$generator = new EmbeddingGenerator();

\$query = '$QUERY';
\$queryEmbedding = \$generator->generateEmbedding(\$query);

\$stmt = \$db->prepare('
    SELECT ce.text_chunk, ce.embedding_vector, sc.title
    FROM content_embeddings ce
    JOIN scraped_content sc ON ce.content_id = sc.content_id
    WHERE sc.has_embeddings = TRUE
');
\$stmt->execute();
\$embeddings = \$stmt->fetchAll();

\$similarities = [];
foreach (\$embeddings as \$row) {
    \$vec = \$generator->deserializeEmbedding(\$row['embedding_vector']);
    \$vec = array_values(\$vec);
    \$sim = \$generator->cosineSimilarity(\$queryEmbedding, \$vec);
    if (\$sim >= 0.3) {
        \$similarities[] = ['chunk' => \$row['text_chunk'], 'similarity' => \$sim];
    }
}

usort(\$similarities, function(\$a, \$b) { return \$b['similarity'] <=> \$a['similarity']; });
echo count(\$similarities) . ' relevant chunks found\n';
if (count(\$similarities) > 0) {
    echo 'Top similarity: ' . number_format(\$similarities[0]['similarity'], 3) . '\n';
}
")

echo "$RETRIEVE_RESULT"
if echo "$RETRIEVE_RESULT" | grep -q "relevant chunks found"; then
    pass "Context retrieval works"
else
    fail "Context retrieval failed"
fi
echo

# Step 5: Test full chat integration
echo "Step 5: Test chat with RAG context"
info "This requires agent_service to be running"

if ! curl -sf http://localhost:8080/health > /dev/null 2>&1; then
    info "agent_service not running - skipping chat integration test"
else
    pass "agent_service is healthy"
    # Full chat integration would be tested here
fi
echo

# Step 6: Verify database state
echo "Step 6: Verify database state"
DB_CHECK=$(mysql -u professorhawkeinstein_user -pBT1716lit professorhawkeinstein_platform -se "
SELECT 
    COUNT(*) as total_embeddings,
    COUNT(DISTINCT content_id) as content_with_embeddings
FROM content_embeddings
" 2>/dev/null)

echo "Database state: $DB_CHECK"
if echo "$DB_CHECK" | grep -q "[0-9]"; then
    pass "Database state verified"
else
    fail "Database check failed"
fi
echo

echo "=== All RAG Tests Passed ==="
echo
echo "Summary:"
echo "- Migration applied ✓"
echo "- Test content created/found ✓"
echo "- Embeddings generated ✓"
echo "- Context retrieval works ✓"
echo "- Database state verified ✓"
echo
echo "Manual validation:"
echo "1. Check embeddings: SELECT COUNT(*) FROM content_embeddings;"
echo "2. Check content: SELECT content_id, title, has_embeddings, embedding_count FROM scraped_content WHERE has_embeddings = TRUE;"
echo "3. Test API: curl -X POST http://localhost/basic_educational/api/agent/retrieve_context.php -H 'Content-Type: application/json' -d '{\"query\":\"What is addition?\",\"top_k\":3}'"
echo
