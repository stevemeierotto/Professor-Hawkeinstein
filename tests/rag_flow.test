#!/bin/bash
# Phase 6 RAG Flow Validation

set -euo pipefail

TEST_NAME="RAG Flow Test"
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
LLAMA_URL="${LLAMA_SERVER_URL:-http://127.0.0.1:8090}"
AGENT_SERVICE_URL="${AGENT_SERVICE_URL:-http://127.0.0.1:8080}"
AGENT_LOG="/tmp/agent_service_full.log"

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

function pass() {
    printf "%b\n" "${GREEN}✓${NC} $1"
}

function fail() {
    printf "%b\n" "${RED}✗${NC} $1"
    exit 1
}

function info() {
    printf "%b\n" "${YELLOW}ℹ${NC} $1"
}

function require_command() {
    if ! command -v "$1" >/dev/null 2>&1; then
        fail "Required command '$1' not found in PATH"
    fi
}

function parse_seed_output() {
    local output="$1"
    declare -gA SEED_MAP=()
    while IFS='=' read -r key value; do
        [[ -z "${key}" ]] && continue
        SEED_MAP["$key"]="$value"
    done <<< "$output"
}

info "=== $TEST_NAME ==="
info "Validating metadata-aware RAG pipeline end-to-end"

require_command mysql
require_command php
require_command curl

info "Loading database credentials from config/database.php"
DB_HOST=$(php -r "require '$PROJECT_ROOT/config/database.php'; echo DB_HOST;" | tr -d '\n')
DB_PORT=$(php -r "require '$PROJECT_ROOT/config/database.php'; echo DB_PORT;" | tr -d '\n')
DB_NAME=$(php -r "require '$PROJECT_ROOT/config/database.php'; echo DB_NAME;" | tr -d '\n')
DB_USER=$(php -r "require '$PROJECT_ROOT/config/database.php'; echo DB_USER;" | tr -d '\n')
DB_PASS=$(php -r "require '$PROJECT_ROOT/config/database.php'; echo DB_PASS;" | tr -d '\n')

export MYSQL_PWD="$DB_PASS"
MYSQL_CMD=(mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" --default-character-set=utf8mb4 "$DB_NAME")

info "Checking llama-server health at $LLAMA_URL"
curl -fsS "$LLAMA_URL/health" >/dev/null || fail "llama-server is not healthy on $LLAMA_URL"
pass "llama-server healthy"

info "Checking agent_service health at $AGENT_SERVICE_URL"
curl -fsS "$AGENT_SERVICE_URL/health" >/dev/null || fail "agent_service is not healthy on $AGENT_SERVICE_URL"
pass "agent_service healthy"

info "Seeding deterministic RAG dataset via tests/rag_seed_content.php"
SEED_OUTPUT=$(php "$PROJECT_ROOT/tests/rag_seed_content.php")
parse_seed_output "$SEED_OUTPUT"

AGENT_ID="${SEED_MAP[AGENT_ID]:-}"
USER_ID="${SEED_MAP[USER_ID]:-}"
PRIMARY_CONTENT_ID="${SEED_MAP[PRIMARY_CONTENT_ID]:-}"
ALL_CONTENT_IDS="${SEED_MAP[ALL_CONTENT_IDS]:-}"
AGENT_SCOPE="${SEED_MAP[AGENT_SCOPE]:-}"
TEST_QUERY="${SEED_MAP[TEST_QUERY]:-}"
QUERY_VECTOR="${SEED_MAP[QUERY_VECTOR]:-}"

if [[ -z "$AGENT_ID" || -z "$USER_ID" || -z "$PRIMARY_CONTENT_ID" || -z "$ALL_CONTENT_IDS" || -z "$TEST_QUERY" || -z "$QUERY_VECTOR" ]]; then
    echo "$SEED_OUTPUT"
    fail "Seed data incomplete; ensure rag_seed_content.php completed successfully"
fi

IFS=',' read -r -a CONTENT_IDS <<< "$ALL_CONTENT_IDS"
if [[ ${#CONTENT_IDS[@]} -lt 2 ]]; then
    fail "Expected multiple content IDs but received: $ALL_CONTENT_IDS"
fi
pass "Seeded dataset for content IDs: $ALL_CONTENT_IDS"

info "Verifying content_embeddings.embedding_vector uses MariaDB VECTOR type"
VECTOR_TYPE=$("${MYSQL_CMD[@]}" -N -B -e "SELECT DATA_TYPE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA='${DB_NAME}' AND TABLE_NAME='content_embeddings' AND COLUMN_NAME='embedding_vector';")
[[ "$VECTOR_TYPE" == "vector" ]] || fail "content_embeddings.embedding_vector is '$VECTOR_TYPE' (expected VECTOR)"
pass "VECTOR column confirmed"

info "Ensuring embeddings exist for every seeded content item"
CHUNK_TOTAL=$("${MYSQL_CMD[@]}" -N -B -e "SELECT COUNT(*) FROM content_embeddings WHERE content_id IN ($ALL_CONTENT_IDS);")
[[ "$CHUNK_TOTAL" -ge ${#CONTENT_IDS[@]} ]] || fail "Only $CHUNK_TOTAL embeddings found for content_ids $ALL_CONTENT_IDS"
PRIMARY_COUNT=$("${MYSQL_CMD[@]}" -N -B -e "SELECT COUNT(*) FROM content_embeddings WHERE content_id=$PRIMARY_CONTENT_ID;")
[[ "$PRIMARY_COUNT" -eq 1 ]] || fail "Primary content_id $PRIMARY_CONTENT_ID expected exactly 1 chunk"
pass "Embeddings present ($CHUNK_TOTAL total rows)"

info "Validating chunk metadata with agent scope '$AGENT_SCOPE'"
META_SQL="SELECT COUNT(*) FROM content_embeddings WHERE content_id IN ($ALL_CONTENT_IDS) AND JSON_UNQUOTE(JSON_EXTRACT(chunk_metadata, '$.agent_scope')) = '$AGENT_SCOPE' AND JSON_UNQUOTE(JSON_EXTRACT(chunk_metadata, '$.grade_level')) <> '' AND JSON_UNQUOTE(JSON_EXTRACT(chunk_metadata, '$.subject')) <> '';"
META_COUNT=$("${MYSQL_CMD[@]}" -N -B -e "$META_SQL")
[[ "$META_COUNT" -eq ${#CONTENT_IDS[@]} ]] || fail "Metadata missing for $(( ${#CONTENT_IDS[@]} - META_COUNT )) chunk(s)"
pass "Chunk metadata stored"

info "Computing similarity ordering via VEC_Cosine_Distance"
SIMILARITY_SQL="SELECT content_id, chunk_index, ROUND(1 - VEC_Cosine_Distance(embedding_vector, VEC_FromText('$QUERY_VECTOR')), 4) AS similarity FROM content_embeddings WHERE content_id IN ($ALL_CONTENT_IDS) ORDER BY similarity DESC;"
SIMILARITY_ROWS=$("${MYSQL_CMD[@]}" -N -B -e "$SIMILARITY_SQL")
[[ -n "$SIMILARITY_ROWS" ]] || fail "Similarity query returned no rows"

TOP_CONTENT_ID=$(awk -F'\t' 'NR==1 {print $1}' <<< "$SIMILARITY_ROWS")
TOP_SIM=$(awk -F'\t' 'NR==1 {print $3}' <<< "$SIMILARITY_ROWS")
[[ "$TOP_CONTENT_ID" == "$PRIMARY_CONTENT_ID" ]] || fail "Expected content $PRIMARY_CONTENT_ID to rank first but saw $TOP_CONTENT_ID"
pass "Primary content ranked first (similarity $TOP_SIM)"

info "Similarity ranking (content_id chunk_index similarity):"
while IFS=$'\t' read -r content chunk sim; do
    [[ -z "$content" ]] && continue
    printf "    %s chunk %s -> %s\n" "$content" "$chunk" "$sim"
done <<< "$SIMILARITY_ROWS"

info "Calling $AGENT_SERVICE_URL/agent/chat with seeded query"
CHAT_BODY=$(php -r '$payload=["userId"=>(int)$argv[1],"agentId"=>(int)$argv[2],"message"=>$argv[3]]; echo json_encode($payload, JSON_UNESCAPED_UNICODE);' "$USER_ID" "$AGENT_ID" "$TEST_QUERY")
CHAT_RESPONSE=$(curl -fsS -X POST -H "Content-Type: application/json" -d "$CHAT_BODY" "$AGENT_SERVICE_URL/agent/chat")
CHAT_SUCCESS=$(php -r '$data=json_decode(stream_get_contents(STDIN), true); echo !empty($data["success"]) ? "1" : "";' <<< "$CHAT_RESPONSE")
[[ -n "$CHAT_SUCCESS" ]] || fail "agent_service response did not include success=true"
CHAT_SNIPPET=$(php -r '$data=json_decode(stream_get_contents(STDIN), true); $text=isset($data["response"]) ? trim(preg_replace("/\s+/", " ", $data["response"])) : ""; echo substr($text, 0, 140);' <<< "$CHAT_RESPONSE")
pass "agent_service responded"
info "Agent response snippet: $CHAT_SNIPPET"

info "Verifying RAG logs emitted to $AGENT_LOG"
[[ -f "$AGENT_LOG" ]] || fail "Agent log $AGENT_LOG not found"
LOG_WINDOW=$(tail -n 400 "$AGENT_LOG")
[[ -n "$LOG_WINDOW" ]] || fail "Agent log is empty"
grep -Fq "[RAGEngine] RAGSearch" <<< "$LOG_WINDOW" || fail "RAGEngine search log entry missing"
grep -Fq "[AgentManager] Injected" <<< "$LOG_WINDOW" || fail "AgentManager injection log missing"
pass "Log entries confirmed"
info "Recent RAG log lines:"
echo "$LOG_WINDOW" | grep -E "RAGEngine|AgentManager" | tail -n 5 | sed 's/^/    /'

echo
echo "Summary:"
echo "- Seeded dataset for content IDs: $ALL_CONTENT_IDS"
echo "- VECTOR storage confirmed in content_embeddings"
echo "- Similarity search ranked content $PRIMARY_CONTENT_ID first"
echo "- /agent/chat returned success and logged RAG context"
echo "- Detailed manual drill-down: ./tests/rag_manual_verify.sh"
echo
pass "All RAG validations completed"

