#!/bin/bash
# Chat API Authentication Test
# Verifies that chat.php properly rejects unauthorized requests

set -euo pipefail

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "=== Chat API Authentication Test ==="
echo ""

API_BASE="http://localhost/basic_educational/api"
CHAT_ENDPOINT="$API_BASE/agent/chat.php"

TESTS_PASSED=0
TESTS_FAILED=0

# Helper function
test_request() {
    local description="$1"
    local expected_code="$2"
    local auth_header="$3"
    local data="$4"
    
    echo -n "Testing: $description ... "
    
    if [ -n "$auth_header" ]; then
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$CHAT_ENDPOINT" \
            -H "Content-Type: application/json" \
            -H "Authorization: $auth_header" \
            -d "$data" 2>/dev/null)
    else
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$CHAT_ENDPOINT" \
            -H "Content-Type: application/json" \
            -d "$data" 2>/dev/null)
    fi
    
    HTTP_CODE=$(echo "$RESPONSE" | tail -1)
    BODY=$(echo "$RESPONSE" | head -n -1)
    
    if [ "$HTTP_CODE" = "$expected_code" ]; then
        echo -e "${GREEN}✓ PASSED${NC} (HTTP $HTTP_CODE)"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        return 0
    else
        echo -e "${RED}✗ FAILED${NC} (Expected $expected_code, got $HTTP_CODE)"
        echo "  Response: $BODY"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        return 1
    fi
}

echo "Chat API Endpoint: $CHAT_ENDPOINT"
echo ""

# Test data
TEST_DATA='{"agentId":1,"message":"Hello"}'

# Test 1: No Authorization header
test_request "No Authorization header" "401" "" "$TEST_DATA"

# Test 2: Empty Authorization header
test_request "Empty Authorization header" "401" "" "$TEST_DATA"

# Test 3: Invalid Bearer token format
test_request "Invalid Bearer token format" "401" "InvalidFormat" "$TEST_DATA"

# Test 4: Malformed Bearer token
test_request "Malformed Bearer token" "401" "Bearer" "$TEST_DATA"

# Test 5: Invalid Bearer token (random string)
test_request "Invalid Bearer token" "401" "Bearer invalid_token_12345" "$TEST_DATA"

# Test 6: Expired token (if you have one for testing)
test_request "Expired token" "401" "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.expired" "$TEST_DATA"

echo ""
echo "=== Additional Endpoint Tests ==="
echo ""

# Test other agent endpoints
ENDPOINTS=(
    "$API_BASE/agent/list.php"
    "$API_BASE/agent/history.php?agentId=1"
)

for endpoint in "${ENDPOINTS[@]}"; do
    echo -n "Testing: $(basename $endpoint) without auth ... "
    
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$endpoint" 2>/dev/null)
    
    if [ "$HTTP_CODE" = "401" ]; then
        echo -e "${GREEN}✓ PASSED${NC} (HTTP $HTTP_CODE)"
        TESTS_PASSED=$((TESTS_PASSED + 1))
    else
        echo -e "${RED}✗ FAILED${NC} (Expected 401, got $HTTP_CODE)"
        TESTS_FAILED=$((TESTS_FAILED + 1))
    fi
done

echo ""
echo "========================================"
TOTAL_TESTS=$((TESTS_PASSED + TESTS_FAILED))
echo "Tests run: $TOTAL_TESTS"
echo "Passed: $TESTS_PASSED"
echo "Failed: $TESTS_FAILED"
echo ""

if [ $TESTS_FAILED -eq 0 ]; then
    echo -e "${GREEN}✅ All authentication tests passed!${NC}"
    echo ""
    echo "Security verification:"
    echo "  ✓ chat.php rejects requests without token"
    echo "  ✓ Invalid tokens are rejected"
    echo "  ✓ Malformed tokens are rejected"
    echo "  ✓ Other agent endpoints properly protected"
    exit 0
else
    echo -e "${RED}⚠️  $TESTS_FAILED test(s) failed${NC}"
    echo ""
    echo "Potential issues:"
    echo "  - Authentication not properly enforced"
    echo "  - Test bypasses still present"
    echo "  - Missing requireAuth() calls"
    exit 1
fi
