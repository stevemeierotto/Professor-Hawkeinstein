<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login - Professor Hawkeinstein's Educational Foundation</title>
    <link rel="stylesheet" href="styles.css">
    <script src="auth_storage.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <span class="logo">üéì Professor Hawkeinstein's Educational Foundation</span>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="login.html">Student Login</a></li>
            </ul>
        </div>
    </nav>

    <!-- Admin Login Form Container -->
    <div class="form-container">
        <div class="text-center" style="margin-bottom: 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üîê</div>
            <h2>Admin Access</h2>
            <p style="color: var(--text-light);">Authorized Personnel Only</p>
        </div>

        <!-- Alert for demo purposes -->
        <div class="alert alert-info">
            <strong>Admin Demo:</strong> Use username: <code>root</code> / password: <code>Root1234</code>
        </div>

        <!-- Admin Login Form -->
        <form id="adminLoginForm">
            <div class="form-group">
                <label for="username">Admin Username</label>
                <input type="text" id="username" name="username" required placeholder="Enter admin username">
            </div>

            <div class="form-group">
                <label for="password">Admin Password</label>
                <input type="password" id="password" name="password" required placeholder="Enter admin password">
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; background: #f59e0b;">
                üîí Admin Login
            </button>
        </form>

        <!-- Divider -->
        <div class="text-center" style="margin: 1.5rem 0; position: relative;">
            <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--border-color);"></div>
            <span style="position: relative; background: white; padding: 0 1rem; color: var(--text-light);">or</span>
        </div>

        <!-- Google Sign-In Button -->
        <button id="google-signin-btn" class="btn" style="width: 100%; background: white; color: #444; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 0.75rem; font-weight: 500;">
            <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                <g fill="none" fill-rule="evenodd">
                    <path d="M17.64 9.205c0-.639-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/>
                    <path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/>
                    <path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                    <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
                </g>
            </svg>
            Sign in with Google
        </button>

        <div class="text-center mt-3">
            <p style="font-size: 0.9rem; color: var(--text-light);">
                Not an admin? <a href="login.html" style="color: var(--primary-color); text-decoration: none;">Student Login</a>
            </p>
        </div>

        <div class="alert alert-warning mt-3">
            <strong>‚ö†Ô∏è Security Notice:</strong> All admin access attempts are logged and monitored.
        </div>
    </div>

    <script>
        // Handle OAuth callback on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Check for OAuth success in URL query params (not hash)
            const urlParams = new URLSearchParams(window.location.search);
            const oauthSuccess = urlParams.get('oauth_success');
            const userId = urlParams.get('user_id');
            const username = urlParams.get('username');
            const role = urlParams.get('role');

            if (oauthSuccess === 'true') {
                console.log('OAuth login successful:', { userId, username, role });
                // Verify admin role
                if (role === 'admin' || role === 'root') {
                    const userData = {
                        username: username,
                        userId: parseInt(userId),
                        role: role
                    };
                    // Only set user info in sessionStorage (token is in httpOnly cookie)
                    setAdminSession('user', userData);
                    // Clear query params from URL
                    window.location.replace('admin_dashboard.html');
                } else {
                    alert('Access Denied: This Google account does not have admin privileges.');
                    window.location.replace('admin_login.html');
                }
                return;
            }

            // Check for OAuth error
            const oauthError = urlParams.get('oauth_error');
            if (oauthError) {
                alert('Google sign-in failed: ' + oauthError);
                // Clear error from URL
                window.location.replace('admin_login.html');
            }
        });

        // Google Sign-In Button Handler
        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('../api/auth/google/login.php');
                const data = await response.json();
                
                if (data.success) {
                    // Redirect to Google's authorization page
                    window.location.href = data.authorization_url;
                } else {
                    alert('OAuth initialization failed: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('OAuth error:', error);
                alert('Failed to start Google sign-in. Please try again.');
            }
        });

        // Admin Login Form Handler
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'üîÑ Authenticating...';
            submitBtn.disabled = true;

            try {
                // Call login API endpoint
                console.log('Making login request...');
                const response = await fetch('api/auth/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                const responseText = await response.text();
                console.log('Response text:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('Admin login response:', data);
                } catch (e) {
                    console.error('JSON parse error:', e);
                    console.error('Could not parse response as JSON');
                    throw new Error('Invalid JSON response from server');
                }

                if (data.success) {
                    console.log('Login successful, checking role...');
                    // Check if user has admin role
                    if (data.user && (data.user.role === 'admin' || data.user.role === 'root')) {
                        console.log('User is admin/root, storing data...');
                        // Store token and user using admin-namespaced storage
                        const userData = {
                            username: data.user.username,
                            name: data.user.name,
                            userId: data.user.userId,
                            role: data.user.role
                        };
                        
                        setAdminSession('token', data.token);
                        setAdminSession('user', userData);
                        // Also store token in localStorage for reload fallback
                        localStorage.setItem('adminToken', data.token);
                        
                        console.log('Stored admin session:', {
                            token: getAdminSession('token'),
                            user: getAdminSession('user')
                        });
                        
                        // Small delay to ensure storage is written
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // Verify storage one more time before redirect
                        const verifyToken = getAdminSession('token');
                        const verifyUser = getAdminSession('user');
                        console.log('Pre-redirect verification:', {
                            tokenExists: !!verifyToken,
                            userExists: !!verifyUser,
                            userRole: verifyUser ? verifyUser.role : 'none'
                        });
                        
                        // Redirect to admin dashboard
                        console.log('Redirecting to admin dashboard');
                        window.location.href = 'admin_dashboard.html';
                    } else {
                        // Not an admin account
                        alert('Access Denied: This account does not have admin privileges.');
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                } else {
                    // STEP 4: Handle auth provider enforcement error
                    if (data.error_code === 'AUTH_PROVIDER_REQUIRED') {
                        // User must use Google SSO instead of password
                        alert(
                            '‚ö†Ô∏è ' + data.message + '\n\n' +
                            data.instructions + '\n\n' +
                            'Admin accounts require Google Sign-In for enhanced security.'
                        );
                        console.log('Auth provider required:', data.required_provider);
                        
                        // Optionally auto-scroll to Google button
                        document.getElementById('google-signin-btn').scrollIntoView({ behavior: 'smooth' });
                    } else {
                        // Generic login error
                        alert(data.message || 'Login failed. Please check your credentials.');
                    }
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Login error:', error);
                console.error('Error stack:', error.stack);
                alert('Connection error. Please try again. Check console for details.');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
