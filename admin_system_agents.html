<!DOCTYPE html>
<html lang="en">
<head>
    <script src="auth_storage.js"></script>
    <script src="admin_auth.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Agents - Professor Hawkeinstein's Educational Foundation</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .agent-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .agent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .agent-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .agent-icon {
            font-size: 2.5rem;
        }

        .agent-title {
            flex: 1;
        }

        .agent-title h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .agent-title p {
            margin: 0.25rem 0 0 0;
            opacity: 0.9;
            font-size: 0.85rem;
        }

        .agent-body {
            padding: 1.25rem;
        }

        .agent-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            text-align: center;
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 8px;
        }

        .stat-item .value {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-item .label {
            font-size: 0.7rem;
            color: var(--text-light);
            text-transform: uppercase;
        }

        .agent-actions {
            display: flex;
            gap: 0.5rem;
        }

        .agent-actions .btn {
            flex: 1;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-help {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .page-header h1 {
            margin: 0;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-box p {
            margin: 0;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <span class="logo">üéì Professor Hawkeinstein's Educational Foundation</span>
            <ul class="nav-links">
                <li><a href="admin_dashboard.html">‚Üê Dashboard</a></li>
                <li><span id="adminName" style="color: var(--text-light);">Root Administrator</span></li>
                <li><a href="#" id="logoutBtn">Logout</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="max-width: 1400px; margin-top: 2rem;">
        <div class="page-header">
            <div>
                <h1>‚öôÔ∏è System Agents</h1>
                <p style="color: var(--text-light); margin-top: 0.5rem;">Configure AI agents used in course creation pipeline</p>
            </div>
            <button class="btn btn-primary" onclick="createNewAgent()">‚ûï Add System Agent</button>
        </div>

        <div class="info-box">
            <p>üí° System agents power the course creation pipeline. Each agent has a specialized role and prompt optimized for its task. Adjust temperature and context limits to fine-tune behavior.</p>
        </div>

        <!-- Agent Cards Grid -->
        <div class="agent-grid" id="agentGrid">
            <!-- Cards will be populated by JavaScript -->
            <div style="text-align: center; padding: 3rem; color: var(--text-light);">
                Loading system agents...
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Edit System Agent</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="agentId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="agentName">Agent Name</label>
                        <input type="text" id="agentName" placeholder="e.g., Outline Generator">
                    </div>
                    <div class="form-group">
                        <label for="agentRole">Pipeline Role</label>
                        <select id="agentRole">
                            <option value="standards">Standards Analyzer</option>
                            <option value="outline">Outline Generator</option>
                            <option value="content">Content Creator</option>
                            <option value="questions">Question Generator</option>
                            <option value="quiz">Quiz Creator</option>
                            <option value="unit_test">Unit Test Creator</option>
                            <option value="validator">Content Validator</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="agentDescription">Description</label>
                    <input type="text" id="agentDescription" placeholder="Brief description of agent's purpose">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="temperature">Temperature</label>
                        <input type="number" id="temperature" min="0" max="2" step="0.1" value="0.7">
                        <p class="form-help">0 = deterministic, 1 = creative, 2 = very random</p>
                    </div>
                    <div class="form-group">
                        <label for="maxTokens">Max Output Tokens</label>
                        <input type="number" id="maxTokens" min="64" max="8192" step="64" value="2048">
                        <p class="form-help">Maximum response length</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="systemPrompt">System Prompt</label>
                    <textarea id="systemPrompt" placeholder="Enter the system prompt that defines this agent's behavior..."></textarea>
                    <p class="form-help">This prompt is sent before every request to establish the agent's role and behavior.</p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="modelName">Model</label>
                        <input type="text" id="modelName" value="default" placeholder="Model name or 'default'">
                    </div>
                    <div class="form-group">
                        <label for="isActive">Status</label>
                        <select id="isActive">
                            <option value="1">Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAgent()">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const token = sessionStorage.getItem('admin_token');
        let systemAgents = [];

        // Agent role configurations with icons and colors
        const roleConfig = {
            'standards': { icon: 'üìã', color: '#3b82f6', label: 'Standards Analyzer' },
            'outline': { icon: 'üìù', color: '#8b5cf6', label: 'Outline Generator' },
            'content': { icon: 'üìö', color: '#10b981', label: 'Content Creator' },
            'questions': { icon: '‚ùì', color: '#f59e0b', label: 'Question Generator' },
            'quiz': { icon: 'üìä', color: '#ec4899', label: 'Quiz Creator' },
            'unit_test': { icon: 'üéØ', color: '#ef4444', label: 'Unit Test Creator' },
            'validator': { icon: '‚úÖ', color: '#06b6d4', label: 'Content Validator' },
            'other': { icon: '‚öôÔ∏è', color: '#6b7280', label: 'Other' }
        };

        // Load system agents on page load
        document.addEventListener('DOMContentLoaded', loadSystemAgents);

        async function loadSystemAgents() {
            try {
                const res = await fetch('api/admin/list_system_agents.php', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.success) {
                    systemAgents = data.agents;
                    renderAgentCards();
                } else {
                    document.getElementById('agentGrid').innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-light);">
                            Error loading agents: ${data.message}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('agentGrid').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-light);">
                        Failed to load system agents. Please try again.
                    </div>
                `;
            }
        }

        function renderAgentCards() {
            const grid = document.getElementById('agentGrid');

            if (systemAgents.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-light); grid-column: 1/-1;">
                        <p style="font-size: 3rem; margin-bottom: 1rem;">‚öôÔ∏è</p>
                        <p>No system agents configured yet.</p>
                        <p>Click "Add System Agent" to create one.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = systemAgents.map(agent => {
                const role = roleConfig[agent.agent_role] || roleConfig['other'];
                const promptPreview = agent.system_prompt ? 
                    agent.system_prompt.substring(0, 100) + (agent.system_prompt.length > 100 ? '...' : '') : 
                    'No prompt configured';

                return `
                    <div class="agent-card">
                        <div class="agent-header" style="background: linear-gradient(135deg, ${role.color}, ${role.color}dd);">
                            <div class="agent-icon">${role.icon}</div>
                            <div class="agent-title">
                                <h3>${escapeHtml(agent.agent_name)}</h3>
                                <p>${role.label}</p>
                            </div>
                            <span class="status-badge ${agent.is_active ? 'status-active' : 'status-inactive'}">
                                ${agent.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <div class="agent-body">
                            <div class="agent-stats">
                                <div class="stat-item">
                                    <div class="value">${agent.temperature || '0.7'}</div>
                                    <div class="label">Temperature</div>
                                </div>
                                <div class="stat-item">
                                    <div class="value">${agent.max_tokens || '2048'}</div>
                                    <div class="label">Max Tokens</div>
                                </div>
                                <div class="stat-item">
                                    <div class="value">${agent.system_prompt ? agent.system_prompt.length : 0}</div>
                                    <div class="label">Prompt Chars</div>
                                </div>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem; min-height: 40px;">
                                ${escapeHtml(promptPreview)}
                            </p>
                            <div class="agent-actions">
                                <button class="btn btn-primary btn-sm" onclick="editAgent(${agent.agent_id})">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="testAgent(${agent.agent_id})">
                                    üß™ Test
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editAgent(agentId) {
            const agent = systemAgents.find(a => a.agent_id === agentId);
            if (!agent) return;

            document.getElementById('modalTitle').textContent = 'Edit System Agent';
            document.getElementById('agentId').value = agent.agent_id;
            document.getElementById('agentName').value = agent.agent_name || '';
            document.getElementById('agentRole').value = agent.agent_role || 'other';
            document.getElementById('agentDescription').value = agent.specialization || '';
            document.getElementById('temperature').value = agent.temperature || 0.7;
            document.getElementById('maxTokens').value = agent.max_tokens || 2048;
            document.getElementById('systemPrompt').value = agent.system_prompt || '';
            document.getElementById('modelName').value = agent.model_name || 'default';
            document.getElementById('isActive').value = agent.is_active ? '1' : '0';

            document.getElementById('editModal').classList.add('active');
        }

        function createNewAgent() {
            document.getElementById('modalTitle').textContent = 'Create System Agent';
            document.getElementById('agentId').value = '';
            document.getElementById('agentName').value = '';
            document.getElementById('agentRole').value = 'other';
            document.getElementById('agentDescription').value = '';
            document.getElementById('temperature').value = '0.7';
            document.getElementById('maxTokens').value = '2048';
            document.getElementById('systemPrompt').value = '';
            document.getElementById('modelName').value = 'default';
            document.getElementById('isActive').value = '1';

            document.getElementById('editModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        async function saveAgent() {
            const agentId = document.getElementById('agentId').value;
            const data = {
                agent_name: document.getElementById('agentName').value,
                agent_role: document.getElementById('agentRole').value,
                specialization: document.getElementById('agentDescription').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                max_tokens: parseInt(document.getElementById('maxTokens').value),
                system_prompt: document.getElementById('systemPrompt').value,
                model_name: document.getElementById('modelName').value,
                is_active: document.getElementById('isActive').value === '1'
            };

            if (!data.agent_name) {
                alert('Please enter an agent name');
                return;
            }

            try {
                const url = agentId ? 
                    'api/admin/update_system_agent.php' : 
                    'api/admin/create_system_agent.php';

                if (agentId) {
                    data.agent_id = parseInt(agentId);
                }

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    closeModal();
                    loadSystemAgents();
                    alert(agentId ? 'Agent updated successfully!' : 'Agent created successfully!');
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to save agent');
            }
        }

        async function testAgent(agentId) {
            const agent = systemAgents.find(a => a.agent_id === agentId);
            if (!agent) return;

            const testPrompt = prompt(`Test ${agent.agent_name}\n\nEnter a test message:`, 'Hello, can you describe your role?');
            if (!testPrompt) return;

            alert('Testing agent... (check browser console for response)');

            try {
                const res = await fetch('api/agent/chat.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        agentId: agentId,
                        message: testPrompt
                    })
                });

                const result = await res.json();
                console.log('Agent Response:', result);

                if (result.response) {
                    alert('Agent Response:\n\n' + result.response.substring(0, 500) + (result.response.length > 500 ? '...' : ''));
                } else {
                    alert('No response from agent: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to test agent');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Close modal on backdrop click
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('editModal')) closeModal();
        });
    </script>
</body>
</html>
