<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Unit Test - Professor Hawkeinstein</title>
    <link rel="stylesheet" href="styles.css">
    <script src="auth_storage.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: var(--bg-light);
        }

        .quiz-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .quiz-header {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin: -2rem -2rem 2rem -2rem;
        }

        .quiz-header h1 {
            margin: 0 0 0.5rem 0;
            color: white;
        }

        .quiz-meta {
            display: flex;
            gap: 2rem;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
        }

        .question-card {
            background: var(--bg-light);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .question-number {
            font-weight: 600;
            color: var(--primary);
        }

        .question-type {
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
            background: var(--primary);
            color: white;
            border-radius: 4px;
        }

        .question-lesson-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: #f093fb;
            color: white;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        .question-text {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .answer-option {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .answer-option:hover {
            border-color: var(--primary);
            background: #f8f9ff;
        }

        .answer-option.selected {
            border-color: var(--primary);
            background: #e8eaff;
        }

        .answer-option input[type="radio"] {
            margin-right: 0.75rem;
            margin-top: 0.25rem;
        }

        .answer-text {
            flex: 1;
        }

        .short-answer-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
        }

        .short-answer-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .quiz-actions {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border-color);
        }

        .quiz-progress {
            text-align: center;
            color: var(--text-light);
            margin-top: 1rem;
        }

        .loading-message {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .error-message {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
            text-align: center;
        }

        .quiz-complete {
            text-align: center;
            padding: 3rem;
        }

        .quiz-complete h2 {
            color: var(--success-color);
            margin-bottom: 1rem;
        }

        .score-display {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary);
            margin: 2rem 0;
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <div class="quiz-header">
            <h1 id="quizTitle">üéØ Unit Test</h1>
            <div class="quiz-meta">
                <span id="quizCourse"></span>
                <span id="quizUnit"></span>
                <span id="quizQuestionCount"></span>
            </div>
        </div>

        <div id="quizContent">
            <div class="loading-message">
                <p>Loading unit test questions...</p>
            </div>
        </div>

        <div class="quiz-actions" id="quizActions" style="display: none;">
            <button class="btn btn-outline" id="prevQuestion">‚Üê Previous</button>
            <button class="btn btn-primary" id="nextQuestion">Next ‚Üí</button>
        </div>

        <div class="quiz-progress" id="quizProgress"></div>
    </div>

    <script>
        // Development mode flag for logging
        const devMode = false; // Set to true for debugging only
        // Get unit test parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('courseId');
        const unitIndex = urlParams.get('unitIndex');
        const courseName = urlParams.get('courseName') || 'Unknown Course';
        const unitTitle = urlParams.get('unitTitle') || 'Unknown Unit';
        const lessonCount = parseInt(urlParams.get('lessonCount')) || 0;

        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};

        // Load unit test data
        async function loadUnitTest() {
            if (!courseId || unitIndex === null) {
                const quizContent = document.getElementById('quizContent');
                quizContent.textContent = '';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                const h3 = document.createElement('h3');
                h3.textContent = '‚ö†Ô∏è Invalid Test Parameters';
                const p = document.createElement('p');
                p.textContent = 'Missing required course or unit information.';
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline';
                btn.textContent = 'Close Window';
                btn.onclick = () => window.close();
                errorDiv.appendChild(h3);
                errorDiv.appendChild(p);
                errorDiv.appendChild(btn);
                quizContent.appendChild(errorDiv);
                return;
            }

            try {
                const apiUrl = `/api/course/get_unit_test_questions.php?courseId=${courseId}&unitIndex=${unitIndex}`;
                if (devMode) {
                    console.log('Fetching unit test questions from:', apiUrl);
                }
                const response = await fetch(apiUrl);
                
                if (devMode) {
                    console.log('Response status:', response.status, response.statusText);
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseText = await response.text();
                if (devMode) {
                    console.log('Raw API response length:', responseText.length);
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    if (devMode) {
                        console.error('JSON parse error:', parseError);
                    }
                    throw new Error('Unit test data could not be loaded.');
                }

                if (data.success && data.questions) {
                    // Get all questions from all three bags
                    const multipleChoice = data.questions.multiple_choice || [];
                    const fillInBlank = data.questions.fill_in_blank || [];
                    const shortEssay = data.questions.short_essay || [];
                    
                    // Shuffle function
                    const shuffleArray = (arr) => arr.sort(() => Math.random() - 0.5);
                    
                    // FOR TESTING: Use 9 questions (3 of each type)
                    const questionsPerType = 3;
                    
                    console.log(`Unit Test: Selecting ${questionsPerType * 3} questions total (${questionsPerType} per type)`);
                    
                    const selectedMC = shuffleArray([...multipleChoice]).slice(0, Math.min(questionsPerType, multipleChoice.length));
                    const selectedFIB = shuffleArray([...fillInBlank]).slice(0, Math.min(questionsPerType, fillInBlank.length));
                    const selectedEssay = shuffleArray([...shortEssay]).slice(0, Math.min(questionsPerType, shortEssay.length));
                    
                    // Combine and shuffle final test
                    questions = shuffleArray([...selectedMC, ...selectedFIB, ...selectedEssay]);

                    if (questions.length === 0) {
                        const quizContent = document.getElementById('quizContent');
                        quizContent.textContent = '';
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message';
                        const h3 = document.createElement('h3');
                        h3.textContent = 'No Questions Available';
                        const p = document.createElement('p');
                        p.textContent = "This unit doesn't have any test questions yet.";
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-outline';
                        btn.textContent = 'Close Window';
                        btn.onclick = () => window.close();
                        errorDiv.appendChild(h3);
                        errorDiv.appendChild(p);
                        errorDiv.appendChild(btn);
                        quizContent.appendChild(errorDiv);
                        return;
                    }

                    // Update header
                    document.getElementById('quizTitle').textContent = `Unit Test: ${unitTitle}`;
                    document.getElementById('quizCourse').textContent = `üìö ${courseName}`;
                    document.getElementById('quizUnit').textContent = `üìñ ${unitTitle} (${lessonCount} lessons)`;
                    document.getElementById('quizQuestionCount').textContent = `‚ùì ${questions.length} Questions`;

                    // Show first question
                    displayQuestion(0);
                    document.getElementById('quizActions').style.display = 'flex';
                } else {
                    throw new Error(data.message || 'Failed to load unit test data');
                }
            } catch (error) {
                if (devMode) {
                    console.error('Unit test load error:', error);
                }
                const quizContent = document.getElementById('quizContent');
                quizContent.textContent = '';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                const h3 = document.createElement('h3');
                h3.textContent = '‚ö†Ô∏è Error Loading Unit Test';
                const p = document.createElement('p');
                p.textContent = error.message;
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline';
                btn.textContent = 'Close Window';
                btn.onclick = () => window.close();
                errorDiv.appendChild(h3);
                errorDiv.appendChild(p);
                errorDiv.appendChild(btn);
                quizContent.appendChild(errorDiv);
            }
        }

        function displayQuestion(index) {
            currentQuestionIndex = index;
            const question = questions[index];
            
            // Get answer options - API uses 'options', some may have 'choices'
            const answerOptions = question.options || question.choices;
            const questionType = answerOptions ? 'Multiple Choice' : 
                                question.hint ? 'Fill in the Blank' : 'Short Answer';

            const quizContent = document.getElementById('quizContent');
            quizContent.textContent = '';
            const card = document.createElement('div');
            card.className = 'question-card';
            const header = document.createElement('div');
            header.className = 'question-header';
            const leftDiv = document.createElement('div');
            const numSpan = document.createElement('span');
            numSpan.className = 'question-number';
            numSpan.textContent = `Question ${index + 1} of ${questions.length}`;
            leftDiv.appendChild(numSpan);
            if (question.lessonNumber) {
                const lessonBadge = document.createElement('span');
                lessonBadge.className = 'question-lesson-badge';
                lessonBadge.textContent = `Lesson ${question.lessonNumber}`;
                leftDiv.appendChild(lessonBadge);
            }
            header.appendChild(leftDiv);
            const typeSpan = document.createElement('span');
            typeSpan.className = 'question-type';
            typeSpan.textContent = questionType;
            header.appendChild(typeSpan);
            card.appendChild(header);
            const qText = document.createElement('div');
            qText.className = 'question-text';
            qText.textContent = question.question || question.question_text;
            card.appendChild(qText);

            if (answerOptions) {
                // Multiple choice
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'answer-options';
                answerOptions.forEach((choice, i) => {
                    const isSelected = userAnswers[index] === choice;
                    const label = document.createElement('label');
                    label.className = 'answer-option' + (isSelected ? ' selected' : '');
                    label.dataset.index = index;
                    label.dataset.answer = choice;
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `q${index}`;
                    input.value = choice;
                    if (isSelected) input.checked = true;
                    const span = document.createElement('span');
                    span.className = 'answer-text';
                    span.textContent = choice;
                    label.appendChild(input);
                    label.appendChild(span);
                    optionsDiv.appendChild(label);
                });
                card.appendChild(optionsDiv);
            } else {
                // Short answer or fill in blank
                const savedAnswer = userAnswers[index] || '';
                const textarea = document.createElement('textarea');
                textarea.className = 'short-answer-input';
                textarea.dataset.index = index;
                textarea.rows = 4;
                textarea.placeholder = 'Type your answer here...';
                textarea.value = savedAnswer;
                card.appendChild(textarea);
                if (question.hint) {
                    const hintP = document.createElement('p');
                    hintP.style.marginTop = '0.5rem';
                    hintP.style.fontSize = '0.9rem';
                    hintP.style.color = 'var(--text-light)';
                    hintP.textContent = `üí° Hint: ${question.hint}`;
                    card.appendChild(hintP);
                }
            }
            quizContent.appendChild(card);

            // Add event listeners
            document.querySelectorAll('.answer-option').forEach(option => {
                option.addEventListener('click', function() {
                    const idx = parseInt(this.dataset.index);
                    const answer = this.dataset.answer;
                    userAnswers[idx] = answer;
                    
                    // Update UI
                    this.parentElement.querySelectorAll('.answer-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            document.querySelectorAll('.short-answer-input').forEach(input => {
                input.addEventListener('input', function() {
                    const idx = parseInt(this.dataset.index);
                    userAnswers[idx] = this.value;
                });
            });

            // Update navigation buttons
            document.getElementById('prevQuestion').disabled = index === 0;
            document.getElementById('nextQuestion').textContent = index === questions.length - 1 ? 'Submit Test' : 'Next ‚Üí';

            // Update progress - only count non-empty answers
            const answered = Object.keys(userAnswers).filter(key => {
                const answer = userAnswers[key];
                return answer && answer.toString().trim() !== '';
            }).length;
            document.getElementById('quizProgress').textContent = `${answered} of ${questions.length} questions answered`;
        }

        // Navigation
        document.getElementById('prevQuestion').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                displayQuestion(currentQuestionIndex - 1);
            }
        });

        document.getElementById('nextQuestion').addEventListener('click', () => {
            if (currentQuestionIndex < questions.length - 1) {
                displayQuestion(currentQuestionIndex + 1);
            } else {
                submitUnitTest();
            }
        });

        async function submitUnitTest() {
            // Count only non-empty answers
            const answered = Object.keys(userAnswers).filter(key => {
                const answer = userAnswers[key];
                return answer && answer.toString().trim() !== '';
            }).length;
            
            if (answered < questions.length) {
                if (!confirm(`You've only answered ${answered} of ${questions.length} questions. Submit anyway?`)) {
                    return;
                }
            }

            // Show loading state
            document.getElementById('quizContent').innerHTML = `
                <div class="loading-message">
                    <p>Grading your unit test...</p>
                </div>
            `;
            document.getElementById('quizActions').style.display = 'none';
            document.getElementById('quizProgress').style.display = 'none';

            try {
                // Get authentication token
                const token = (typeof getStudentSession !== 'undefined' ? getStudentSession('token') : null) ||
                             sessionStorage.getItem('student_token') || 
                             localStorage.getItem('authToken') || '';
                
                if (devMode) {
                    // Only log token presence, not value
                    console.log('üîç DEBUG - Token present:', !!token);
                }
                
                // Submit unit test for grading (using same quiz grading endpoint)
                const gradeUrl = `/api/progress/submit_quiz.php`;
                if (devMode) {
                    console.log('üîç DEBUG - Grade URL:', gradeUrl);
                }
                
                const response = await fetch(gradeUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    },
                    cache: 'no-store',
                    body: JSON.stringify({
                        courseId: courseId,
                        unitIndex: unitIndex,
                        lessonIndex: null, // null indicates this is a unit test
                        isUnitTest: true,
                        questions: questions,
                        userAnswers: userAnswers
                    })
                });

                if (devMode) {
                    console.log('Grade response status:', response.status);
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    if (devMode) {
                        console.error('Grade API error:', response.status);
                    }
                    throw new Error(`Grading request failed (${response.status})`);
                }

                const responseText = await response.text();
                if (devMode) {
                    console.log('Grade API response received.');
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    if (devMode) {
                        console.error('JSON parse error:', parseError);
                    }
                    throw new Error('Unit test grading failed.');
                }

                if (data.success) {
                    // Display results
                    displayResults(data);
                } else {
                    throw new Error(data.message || 'Grading failed');
                }
            } catch (error) {
                if (devMode) {
                    console.error('Grading error:', error);
                }
                const quizContent = document.getElementById('quizContent');
                quizContent.textContent = '';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                const h3 = document.createElement('h3');
                h3.textContent = '‚ö†Ô∏è Grading Error';
                const p = document.createElement('p');
                p.textContent = error.message;
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline';
                btn.textContent = 'Close Window';
                btn.onclick = () => window.close();
                errorDiv.appendChild(h3);
                errorDiv.appendChild(p);
                errorDiv.appendChild(btn);
                quizContent.appendChild(errorDiv);
            }
        }

        function displayResults(data) {
            const { score, total_questions, correct, partial, incorrect, results } = data;
            
            const passed = score >= 90; // 90% passing threshold
            const resultEmoji = passed ? 'üéâ' : 'üìö';
            const resultMessage = passed ? 'Excellent Work!' : 'Keep Studying!';
            const resultColor = passed ? '#22c55e' : '#f59e0b';
            
            let html = `
                <div class="quiz-complete">
                    <h2 style="color: ${resultColor}">${resultEmoji} ${resultMessage}</h2>
                    <div class="score-display" style="color: ${resultColor}">${score}%</div>
                    <p style="font-size: 1.1rem; margin-bottom: 1rem;">
                        ${passed ? 'You passed the unit test!' : 'Review the material and try again.'}
                    </p>
                    <div style="display: flex; gap: 2rem; justify-content: center; margin: 1.5rem 0;">
                        <div><strong style="color: #22c55e;">${correct}</strong> Correct</div>
                        ${partial > 0 ? `<div><strong style="color: #f59e0b;">${partial}</strong> Partial</div>` : ''}
                        <div><strong style="color: #ef4444;">${incorrect}</strong> Incorrect</div>
                    </div>
            `;

            // Show detailed results
            html += '<div style="margin-top: 2rem; text-align: left;">';
            results.forEach((result, idx) => {
                const gradeColor = result.grade === 'Correct' ? '#22c55e' : 
                                  result.grade === 'Partially Correct' ? '#f59e0b' : '#ef4444';
                const gradeIcon = result.grade === 'Correct' ? '‚úì' : 
                                 result.grade === 'Partially Correct' ? '‚óê' : '‚úó';
                
                html += `
                    <div style="background: var(--bg-light); border-left: 4px solid ${gradeColor}; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <strong>Question ${idx + 1} ${result.lessonNumber ? `(Lesson ${result.lessonNumber})` : ''}</strong>
                            <span style="color: ${gradeColor}; font-weight: 600;">${gradeIcon} ${result.grade}</span>
                        </div>
                        <p style="margin: 0.5rem 0; font-size: 0.95rem;">${result.question_text}</p>
                        <p style="margin: 0.5rem 0; font-size: 0.9rem; color: var(--text-light);">
                            <strong>Your answer:</strong> ${result.user_answer || '<em>No answer</em>'}
                        </p>
                        ${result.grade !== 'Correct' ? `
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: var(--text-light);">
                                <strong>Expected:</strong> ${result.correct_answer}
                            </p>
                        ` : ''}
                    </div>
                `;
            });
            html += '</div>';

            html += `
                    <button class="btn btn-primary" style="margin-top: 2rem;" onclick="window.close()">
                        Close Test
                    </button>
                </div>
            `;

            document.getElementById('quizContent').innerHTML = html;
        }

        // Load unit test on page load
        loadUnitTest();
    </script>
</body>
</html>
