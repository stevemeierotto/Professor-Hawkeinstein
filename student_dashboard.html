<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="auth_storage.js"></script>
    <title>Student Dashboard - Professor Hawkeinstein's Educational Foundation</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="index.html" class="logo">üéì Professor Hawkeinstein's Educational Foundation</a>
            <ul class="nav-links">
                <li><a href="student_dashboard.html">Dashboard</a></li>
                <li><a href="#" id="studentName">John Doe</a></li>
                <li><a href="#" id="logoutBtn" class="btn btn-danger">Logout</a></li>
            </ul>
        </div>
    </nav>

    <!-- Dashboard Container -->
    <div class="container-fluid">
        <div class="dashboard">
            <!-- Sidebar -->
            <aside class="sidebar">
                <h3>Navigation</h3>
                <ul class="sidebar-menu">
                    <li><a href="#overview" class="active">üìä Overview</a></li>
                    <li><a href="#my-courses">üìö My Courses</a></li>
                    <li><a href="#agents">ü§ñ AI Agents</a></li>
                    <li><a href="#progress">üìà Progress</a></li>
                    <li><a href="#settings">‚öôÔ∏è Settings</a></li>
                </ul>

                <hr style="margin: 2rem 0;">

                <h4>Select Your Agent</h4>
                <div id="agentsList" style="margin-top: 1rem;">
                    <p style="text-align: center; color: var(--text-light); font-size: 0.9rem;">Loading agents...</p>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Overview Section (default view) -->
                <div id="overview-section">
                    <!-- Welcome Section -->
                    <div>
                        <h1>Welcome back, <span id="welcomeName">John</span>! üëã</h1>
                        <p style="color: var(--text-light); font-size: 1.1rem;">Continue your learning journey with your AI expert agents</p>
                    </div>

                <!-- Progress Overview Cards -->
                <div class="progress-overview">
                    <div class="progress-card">
                        <h4>Courses In Progress</h4>
                        <div class="progress-value">3</div>
                        <p style="font-size: 0.875rem; color: var(--text-light); margin: 0;">Active learning paths</p>
                    </div>
                    <div class="progress-card">
                        <h4>Overall Mastery</h4>
                        <div class="progress-value">67%</div>
                        <p style="font-size: 0.875rem; color: var(--text-light); margin: 0;">Across all subjects</p>
                    </div>
                    <div class="progress-card">
                        <h4>Study Time</h4>
                        <div class="progress-value">24.5h</div>
                        <p style="font-size: 0.875rem; color: var(--text-light); margin: 0;">This month</p>
                    </div>
                    <div class="progress-card">
                        <h4>Milestones Achieved</h4>
                        <div class="progress-value">12</div>
                        <p style="font-size: 0.875rem; color: var(--text-light); margin: 0;">Keep it up!</p>
                    </div>
                </div>

                <!-- AI Agent Chat Interface -->
                <section style="margin-top: 3rem;">
                    <h2>üí¨ Chat with Your AI Agent</h2>
                    <div class="chat-container">
                        <div class="chat-header" id="chatHeader">
                            <div class="agent-avatar" id="chatAvatar">PH</div>
                            <div>
                                <h4 style="margin: 0; color: white;" id="chatAgentName">Professor Hawkeinstein</h4>
                                <p style="margin: 0; font-size: 0.875rem; opacity: 0.9;" id="chatAgentDesc">Mathematics Expert ‚Ä¢ Online</p>
                            </div>
                        </div>

                        <div class="chat-messages" id="chatMessages">
                            <!-- Agent Message -->
                            <div class="message agent">
                                <div class="message-avatar">PH</div>
                                <div class="message-content">
                                    <p><strong>Professor Hawkeinstein</strong></p>
                                    <p>Hello John! I'm here to help you master mathematics. I remember we were working on quadratic equations last time. Would you like to continue with that, or explore something new today?</p>
                                    <small style="opacity: 0.7;">2:34 PM</small>
                                </div>
                            </div>

                            <!-- User Message -->
                            <div class="message user">
                                <div class="message-avatar">JD</div>
                                <div class="message-content">
                                    <p>I'd like to review the quadratic formula. I'm still a bit confused about when to use it.</p>
                                    <small style="opacity: 0.8;">2:35 PM</small>
                                </div>
                            </div>

                            <!-- Agent Message -->
                            <div class="message agent">
                                <div class="message-avatar">PH</div>
                                <div class="message-content">
                                    <p><strong>Professor Hawkeinstein</strong></p>
                                    <p>Great question! The quadratic formula x = (-b ¬± ‚àö(b¬≤-4ac)) / 2a is used when you have an equation in the form ax¬≤ + bx + c = 0. Let me show you a practical example:</p>
                                    <p>Say we have: 2x¬≤ + 5x - 3 = 0</p>
                                    <p>Here, a=2, b=5, c=-3. Would you like to work through this together?</p>
                                    <small style="opacity: 0.7;">2:36 PM</small>
                                </div>
                            </div>
                        </div>

                        <div class="chat-input-container">
                            <input type="text" id="chatInput" placeholder="Ask your agent anything..." />
                            <button class="btn btn-primary" id="sendBtn">Send</button>
                        </div>
                    </div>
                </section>

                <!-- Active Courses -->
                <section style="margin-top: 3rem;">
                    <h2>üìö Your Active Courses</h2>
                    <div class="courses-grid">
                        <div class="course-card">
                            <div class="course-thumbnail">üìê</div>
                            <div class="course-content">
                                <h3>Algebra Fundamentals</h3>
                                <span class="difficulty-badge difficulty-beginner">Beginner</span>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-label">
                                        <span>Progress</span>
                                        <span><strong>75%</strong></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" style="width: 75%;"></div>
                                    </div>
                                </div>
                                <div class="course-meta">
                                    <span>üïê 15h completed</span>
                                </div>
                                <a href="course_viewer.html?id=1" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Continue Learning</a>
                            </div>
                        </div>

                        <div class="course-card">
                            <div class="course-thumbnail">üî¨</div>
                            <div class="course-content">
                                <h3>Introduction to Physics</h3>
                                <span class="difficulty-badge difficulty-beginner">Beginner</span>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-label">
                                        <span>Progress</span>
                                        <span><strong>45%</strong></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" style="width: 45%;"></div>
                                    </div>
                                </div>
                                <div class="course-meta">
                                    <span>üïê 13.5h completed</span>
                                </div>
                                <a href="course_viewer.html?id=3" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Continue Learning</a>
                            </div>
                        </div>

                        <div class="course-card">
                            <div class="course-thumbnail">‚úçÔ∏è</div>
                            <div class="course-content">
                                <h3>Creative Writing Workshop</h3>
                                <span class="difficulty-badge difficulty-intermediate">Intermediate</span>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-label">
                                        <span>Progress</span>
                                        <span><strong>30%</strong></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" style="width: 30%;"></div>
                                    </div>
                                </div>
                                <div class="course-meta">
                                    <span>üïê 7.5h completed</span>
                                </div>
                                <a href="course_viewer.html?id=4" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Continue Learning</a>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Strengths & Weaknesses -->
                <section style="margin-top: 3rem;">
                    <h2>üìä Your Learning Profile</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem;">
                        <div style="background: var(--bg-light); padding: 1.5rem; border-radius: var(--radius-lg);">
                            <h3 style="color: var(--secondary-color);">üí™ Strengths</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">‚úì Algebraic problem solving</li>
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">‚úì Scientific method understanding</li>
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">‚úì Creative expression</li>
                                <li style="padding: 0.5rem 0;">‚úì Critical thinking</li>
                            </ul>
                        </div>
                        <div style="background: var(--bg-light); padding: 1.5rem; border-radius: var(--radius-lg);">
                            <h3 style="color: var(--warning-color);">üéØ Areas to Improve</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">‚Üí Complex equations (working on it!)</li>
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">‚Üí Physics calculations</li>
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">‚Üí Grammar conventions</li>
                                <li style="padding: 0.5rem 0;">‚Üí Time management</li>
                            </ul>
                        </div>
                    </div>
                </section>
                </div>
                <!-- End Overview Section -->

                <!-- My Courses Section (hidden by default) -->
                <div id="my-courses-section" style="display: none;">
                    <h1>üìö My Courses</h1>
                    <p style="color: var(--text-light); font-size: 1.1rem; margin-bottom: 2rem;">Select a course to open in the workbook</p>
                    
                    <div class="courses-grid">
                        <!-- Algebra I -->
                        <div class="course-card" style="cursor: pointer;" onclick="window.location.href='workbook.html?course=algebra_1'">
                            <div class="course-thumbnail">üìê</div>
                            <div class="course-content">
                                <h3>Algebra I</h3>
                                <span class="difficulty-badge difficulty-beginner">Grade 9</span>
                                <p style="font-size: 0.9rem; color: var(--text-light); margin: 1rem 0;">Foundational algebra concepts including linear equations, polynomials, and functions</p>
                                <div class="course-meta">
                                    <span>üìñ 6 Units</span>
                                    <span style="margin-left: 1rem;">üìù 30 Lessons</span>
                                </div>
                                <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Open in Workbook ‚Üí</button>
                            </div>
                        </div>

                        <!-- Geometry (Coming Soon) -->
                        <div class="course-card" style="opacity: 0.6;">
                            <div class="course-thumbnail">üìè</div>
                            <div class="course-content">
                                <h3>Geometry</h3>
                                <span class="difficulty-badge difficulty-intermediate">Grade 10</span>
                                <p style="font-size: 0.9rem; color: var(--text-light); margin: 1rem 0;">Shapes, angles, proofs, and spatial reasoning</p>
                                <div class="course-meta">
                                    <span>üìñ 6 Units</span>
                                    <span style="margin-left: 1rem;">üìù 30 Lessons</span>
                                </div>
                                <button class="btn btn-secondary" style="width: 100%; margin-top: 1rem;" disabled>üîí Coming Soon</button>
                            </div>
                        </div>

                        <!-- Algebra II (Coming Soon) -->
                        <div class="course-card" style="opacity: 0.6;">
                            <div class="course-thumbnail">üî¢</div>
                            <div class="course-content">
                                <h3>Algebra II</h3>
                                <span class="difficulty-badge difficulty-advanced">Grade 11</span>
                                <p style="font-size: 0.9rem; color: var(--text-light); margin: 1rem 0;">Advanced algebra topics including quadratics, exponentials, and logarithms</p>
                                <div class="course-meta">
                                    <span>üìñ 6 Units</span>
                                    <span style="margin-left: 1rem;">üìù 30 Lessons</span>
                                </div>
                                <button class="btn btn-secondary" style="width: 100%; margin-top: 1rem;" disabled>üîí Coming Soon</button>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 3rem; padding: 2rem; background: var(--bg-light); border-radius: var(--radius-lg); border-left: 4px solid var(--primary);">
                        <h3>üí° How to use the Workbook</h3>
                        <ul style="line-height: 1.8;">
                            <li>Click on any available course to open it in the interactive workbook</li>
                            <li>Navigate through units and lessons using the breadcrumb trail</li>
                            <li>Use Previous/Next buttons to move between lessons</li>
                            <li>Chat with Professor Hawkeinstein for help with any lesson</li>
                            <li>Your progress is automatically saved as you complete lessons</li>
                        </ul>
                    </div>
                </div>
                <!-- End My Courses Section -->
            </main>
        </div>
    </div>

    <script>
        // Check authentication
        const user = getStudentSession('user') || {};
        const token = getStudentSession('token');
        
        if (!user.username || !token) {
            window.location.href = 'login.html';
        } else if (user.role === 'admin' || user.role === 'root') {
            // Redirect admins to admin dashboard
            alert('Admin users cannot access the student dashboard.');
            window.location.href = 'admin_dashboard.html';
        } else {
            document.getElementById('studentName').textContent = user.name;
            document.getElementById('welcomeName').textContent = user.name.split(' ')[0];
        }

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            clearStudentSession();
            window.location.href = 'login.html';
        });

        // Agent selection system
        let activeAgentId = parseInt(getStudentSession('activeAgentId') || '1');
        let agents = [];

        // Get student's advisor instance
        let advisorInstance = null;
        let advisorAgent = null;
        let advisorReady = false;
        let agentServiceOnline = false;

        async function checkAgentService() {
            try {
                console.log('[Status Check] Pinging C++ agent service...');
                const response = await fetch('http://localhost:8080/health', {
                    method: 'GET',
                    signal: AbortSignal.timeout(3000)
                });
                const data = await response.json();
                const isOnline = data.status === 'ok';
                console.log('[Status Check] Agent service response:', data, 'Online:', isOnline);
                return isOnline;
            } catch (error) {
                console.warn('[Status Check] Agent service unreachable:', error.message);
                return false;
            }
        }

        async function updateAgentStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const advisorStatus = document.getElementById('advisorStatus');
            
            // Check C++ agent service
            agentServiceOnline = await checkAgentService();
            
            if (agentServiceOnline && advisorReady && advisorInstance) {
                statusIndicator.innerHTML = '‚óè Online';
                statusIndicator.style.color = '#28a745';
                advisorStatus.textContent = 'Ready to help!';
                advisorStatus.style.color = '#28a745';
            } else if (!agentServiceOnline) {
                statusIndicator.innerHTML = '‚óè Offline';
                statusIndicator.style.color = '#dc3545';
                advisorStatus.textContent = 'Agent service offline';
                advisorStatus.style.color = '#dc3545';
            } else if (!advisorInstance) {
                statusIndicator.innerHTML = '‚óè Loading';
                statusIndicator.style.color = '#ffc107';
                advisorStatus.textContent = 'Loading advisor data...';
                advisorStatus.style.color = '#666';
            }
        }

        async function loadAdvisor() {
            try {
                console.log('[Advisor] Loading advisor data from PHP backend...');
                const ensureResponse = await fetch('api/student/ensure_advisor.php', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + (getStudentSession('token') || '')
                    }
                });
                const ensureData = await ensureResponse.json();
                
                if (ensureData.success && ensureData.advisor_instance) {
                    advisorInstance = ensureData.advisor_instance;
                    advisorAgent = ensureData.advisor_instance;
                    advisorReady = true;
                    console.log('[Advisor] Loaded successfully:', advisorInstance.agent_name);
                } else {
                    console.error('[Advisor] Failed to load:', ensureData.error || ensureData.message);
                    advisorReady = true;
                }
            } catch (error) {
                console.error('[Advisor] Error loading:', error);
                advisorReady = true;
            }
            
            // Update status after loading
            await updateAgentStatus();
        }

        // Start loading advisor and checking status
        loadAdvisor();
        
        // Poll agent status every 15 seconds
        setInterval(updateAgentStatus, 15000);

        // Load available agents from C++ service
        async function loadAgents() {
            try {
                console.log('[Agents] Loading agent list...');
                const response = await fetch('http://localhost:8080/agent/list', {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                agents = Array.isArray(data) ? data : [];
                console.log('[Agents] Loaded', agents.length, 'agents:', agents);
                
                displayAgentCards();
                updateChatHeader();
            } catch (error) {
                console.error('[Agents] Failed to load:', error);
                document.getElementById('agentsList').innerHTML = 
                    '<p style="text-align: center; color: #dc3545; font-size: 0.85rem;">Unable to load agents</p>';
            }
        }

        function getInitials(name) {
            return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
        }

        function displayAgentCards() {
            const container = document.getElementById('agentsList');
            
            if (agents.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); font-size: 0.85rem;">No agents available</p>';
                return;
            }
            
            container.innerHTML = agents.map(agent => {
                const isActive = agent.id === activeAgentId;
                const borderStyle = isActive ? 'border: 2px solid var(--primary); background: rgba(45, 156, 219, 0.05);' : '';
                const badge = isActive ? '<span style="font-size: 0.75rem; color: var(--primary); font-weight: 600;">‚úì Active</span>' : '';
                
                return `
                    <div class="feature-card agent-card" data-agent-id="${agent.id}" style="padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s; ${borderStyle}">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">${agent.avatarEmoji || 'üéì'}</div>
                            <h4 style="margin: 0.5rem 0; font-size: 0.95rem;">${agent.name}</h4>
                            <p style="font-size: 0.8rem; color: var(--text-light); margin: 0.25rem 0;">${agent.description || ''}</p>
                            ${badge}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            document.querySelectorAll('.agent-card').forEach(card => {
                card.addEventListener('click', function() {
                    const agentId = parseInt(this.dataset.agentId);
                    selectAgent(agentId);
                });
            });
        }

        async function selectAgent(agentId) {
            console.log('[Agents] Selecting agent:', agentId);
            activeAgentId = agentId;
            setStudentSession('activeAgentId', agentId.toString());
            
            // Update UI immediately for responsiveness
            displayAgentCards();
            updateChatHeader();
            
            // Track agent selection on backend
            try {
                console.log('[Agents] Recording agent selection on backend...');
                const response = await fetch('api/agent/set_active.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (getStudentSession('token') || '')
                    },
                    body: JSON.stringify({
                        agentId: agentId,
                        userId: user.userId || user.user_id
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[Agents] Selection tracked:', data);
                } else {
                    console.warn('[Agents] Failed to track selection:', response.status);
                }
            } catch (error) {
                console.warn('[Agents] Backend tracking error (non-critical):', error.message);
            }
        }

        function updateChatHeader() {
            const agent = agents.find(a => a.id === activeAgentId);
            if (!agent) return;
            
            const avatar = document.getElementById('chatAvatar');
            const name = document.getElementById('chatAgentName');
            const desc = document.getElementById('chatAgentDesc');
            
            if (avatar) avatar.textContent = getInitials(agent.name);
            if (name) name.textContent = agent.name;
            if (desc) desc.textContent = (agent.description || 'AI Assistant') + ' ‚Ä¢ Online';
        }

        // Load agents on page load
        loadAgents();

        // Chat functionality
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'agent'}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            
            // Get active agent for avatar
            const activeAgent = agents.find(a => a.id === activeAgentId);
            const agentInitials = activeAgent ? getInitials(activeAgent.name) : 'PH';
            const agentName = activeAgent ? activeAgent.name : 'Professor Hawkeinstein';
            
            avatar.textContent = isUser ? getInitials(user.name || 'Student') : agentInitials;
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            if (!isUser) {
                content.innerHTML = `<p><strong>${agentName}</strong></p><p>${text}</p><small style="opacity: 0.7;">${time}</small>`;
            } else {
                content.innerHTML = `<p>${text}</p><small style="opacity: 0.8;">${time}</small>`;
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            chatMessages.appendChild(messageDiv);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;
            
            // Wait for advisor to be ready if not already
            if (!advisorReady) {
                console.log('Waiting for advisor to load...');
                addMessage('Loading advisor... please wait.', false);
                // Poll until advisor is ready
                let attempts = 0;
                while (!advisorReady && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
            }
            
            if (!advisorInstance) {
                addMessage('No advisor assigned. Please contact administration.', false);
                return;
            }

            console.log('Sending message:', text);
            addMessage(text, true);
            chatInput.value = '';
            
            // Store the user message for later use
            const userMessage = text;
            
            // Send to backend API using advisor instance
            const requestData = {
                message: text,
                advisor_instance_id: advisorInstance.advisor_instance_id,
                student_id: user.userId || user.user_id
            };
            
            console.log('Request data:', requestData);
            
            fetch('api/student/update_advisor_data.php', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (getStudentSession('token') || '')
                },
                body: JSON.stringify({
                    conversation_turn: {
                        role: 'student',
                        message: text
                    }
                })
            })
            .then(response => {
                console.log('PHP Response status:', response.status);
                console.log('PHP Response headers:', response.headers);
                return response.text();
            })
            .then(responseText => {
                console.log('PHP Response text (full):', responseText);
                console.log('PHP Response length:', responseText.length);
                try {
                    const data = JSON.parse(responseText);
                    console.log('PHP Parsed data:', data);
                    if (data.success) {
                        console.log('Message stored successfully, now calling agent service');
                        console.log('User message to send:', userMessage);
                        // Call agent service for response using the original user message
                        callAgentService(userMessage);
                    } else {
                        console.log('Error storing message:', data.message);
                        addMessage('Sorry, I encountered an error: ' + (data.message || 'Unknown error'), false);
                    }
                } catch(e) {
                    console.error('JSON parse error:', e);
                    console.error('Failed to parse text:', responseText);
                    addMessage('Sorry, received invalid response from server.', false);
                }
            })
            .catch(error => {
                console.error('Chat error:', error);
                addMessage('Sorry, I\'m having trouble connecting right now. Please try again.', false);
            });
        }

        async function callAgentService(userMessage) {
            console.log('[Agent Chat] Called with message:', userMessage);
            console.log('[Agent Chat] Active agent ID:', activeAgentId);
            
            // Simple payload - let the backend handle conversation history
            const payload = {
                userId: user.userId || user.user_id,
                agentId: activeAgentId,
                message: userMessage
            };

            console.log('[Agent Chat] Calling /agent/chat with payload:', payload);

            fetch('http://localhost:8080/agent/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('Agent service response status:', response.status);
                return response.text();
            })
            .then(responseText => {
                console.log('Agent service response text:', responseText);
                try {
                    const data = JSON.parse(responseText);
                    console.log('Agent service parsed data:', data);
                    if (data.response) {
                        addMessage(data.response, false);
                        // Store agent response
                        storeAgentResponse(data.response);
                    } else {
                        console.error('No response field in data:', data);
                        addMessage('Sorry, I encountered an error: ' + (data.error || 'No response'), false);
                    }
                } catch(e) {
                    console.error('Failed to parse agent response:', e);
                    console.error('Response text was:', responseText);
                    addMessage('Sorry, received invalid response from agent service.', false);
                }
            })
            .catch(error => {
                console.error('Agent service fetch error:', error);
                addMessage('Sorry, I\'m having trouble connecting to the agent service right now.', false);
            });
        }

        function storeAgentResponse(response) {
            fetch('api/student/update_advisor_data.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (getStudentSession('token') || '')
                },
                body: JSON.stringify({
                    conversation_turn: {
                        role: 'advisor',
                        message: response
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Agent response stored');
                    advisorInstance = data.advisor_data;
                }
            })
            .catch(error => console.error('Error storing response:', error));
        }

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Sidebar navigation with section switching
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Update active state
                document.querySelectorAll('.sidebar-menu a').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                // Get the target section from href
                const target = link.getAttribute('href').substring(1); // Remove #
                
                // Hide all sections
                document.getElementById('overview-section').style.display = 'none';
                document.getElementById('my-courses-section').style.display = 'none';
                
                // Show the selected section
                if (target === 'overview') {
                    document.getElementById('overview-section').style.display = 'block';
                } else if (target === 'my-courses') {
                    document.getElementById('my-courses-section').style.display = 'block';
                } else {
                    // For other sections (agents, progress, settings), show overview for now
                    document.getElementById('overview-section').style.display = 'block';
                    // TODO: Implement these sections later
                    console.log('Section not yet implemented:', target);
                }
            });
        });
    </script>
</body>
</html>
