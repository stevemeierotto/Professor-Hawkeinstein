<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login - Professor Hawkeinstein's Educational Foundation</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-header { margin-bottom: 2rem; }
        .admin-icon { font-size: 4rem; margin-bottom: 1rem; }
        .text-light { color: var(--text-light); }
        .btn-admin { width: 100%; background: #f59e0b; }
        .admin-note { font-size: 0.9rem; color: var(--text-light); }
        .link-primary { color: var(--primary-color); text-decoration: none; }
    </style>
    <script src="auth_storage.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <span class="logo">üéì Professor Hawkeinstein's Educational Foundation</span>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="login.html">Student Login</a></li>
            </ul>
        </div>
    </nav>

    <!-- Admin Login Form Container -->
    <div class="form-container">
        <div class="text-center admin-header">
            <div class="admin-icon">üîê</div>
            <h2>Admin Access</h2>
            <p class="text-light">Authorized Personnel Only</p>
        </div>

        <!-- Alert for demo purposes -->
        <div class="alert alert-info">
            <strong>Admin Demo:</strong> Use username: <code>root</code> / password: <code>Root1234</code>
        </div>

        <!-- Admin Login Form -->
        <form id="adminLoginForm">
            <div class="form-group">
                <label for="username">Admin Username</label>
                <input type="text" id="username" name="username" required placeholder="Enter admin username">
            </div>

            <div class="form-group">
                <label for="password">Admin Password</label>
                <input type="password" id="password" name="password" required placeholder="Enter admin password">
            </div>

            <button type="submit" class="btn btn-primary btn-admin">
                üîí Admin Login
            </button>
        </form>

        <div class="text-center mt-3">
            <p class="admin-note">
                Not an admin? <a href="login.html" class="link-primary">Student Login</a>
            </p>
        </div>

        <div class="alert alert-warning mt-3">
            <strong>‚ö†Ô∏è Security Notice:</strong> All admin access attempts are logged and monitored.
        </div>
    </div>

    <script>
        // Admin Login Form Handler
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'üîÑ Authenticating...';
            submitBtn.disabled = true;

            try {
                // Call login API endpoint
                console.log('Making login request...');
                const response = await fetch('api/auth/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                const responseText = await response.text();
                console.log('Response text:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('Admin login response:', data);
                } catch (e) {
                    console.error('JSON parse error:', e);
                    console.error('Could not parse response as JSON');
                    throw new Error('Invalid JSON response from server');
                }

                if (data.success) {
                    console.log('Login successful, checking role...');
                    // Check if user has admin role
                    if (data.user && (data.user.role === 'admin' || data.user.role === 'root')) {
                        console.log('User is admin/root, storing data...');
                        // Store token and user using admin-namespaced storage
                        const userData = {
                            username: data.user.username,
                            name: data.user.name,
                            userId: data.user.userId,
                            role: data.user.role
                        };
                        
                        setAdminSession('token', data.token);
                        setAdminSession('user', userData);
                        
                        console.log('Stored admin session:', {
                            token: getAdminSession('token'),
                            user: getAdminSession('user')
                        });
                        
                        // Small delay to ensure storage is written
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // Verify storage one more time before redirect
                        const verifyToken = getAdminSession('token');
                        const verifyUser = getAdminSession('user');
                        console.log('Pre-redirect verification:', {
                            tokenExists: !!verifyToken,
                            userExists: !!verifyUser,
                            userRole: verifyUser ? verifyUser.role : 'none'
                        });
                        
                        // Redirect to admin dashboard
                        console.log('Redirecting to admin dashboard');
                        window.location.href = 'admin_dashboard.html';
                    } else {
                        // Not an admin account
                        alert('Access Denied: This account does not have admin privileges.');
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                } else {
                    alert(data.message || 'Login failed. Please check your credentials.');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Login error:', error);
                console.error('Error stack:', error.stack);
                alert('Connection error. Please try again. Check console for details.');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
