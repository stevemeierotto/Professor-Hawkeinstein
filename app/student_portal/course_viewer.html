<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="auth_storage.js"></script>
    <title>Course Viewer - Professor Hawkeinstein's Educational Foundation</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="index.html" class="logo">üéì Professor Hawkeinstein's Educational Foundation</a>
            <ul class="nav-links">
                <li><a href="student_dashboard.html">‚Üê Back to Dashboard</a></li>
                <li><a href="#" id="studentName">John Doe</a></li>
                <li>
                    <button id="agentChatBubble" class="agent-chat-bubble" title="Chat with your AI agent">
                        <span class="bubble-icon">üí¨</span>
                        <span class="bubble-badge" id="unreadBadge" style="display: none;">0</span>
                    </button>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Floating Agent Chat Panel -->
    <div id="agentChatPanel" class="agent-chat-panel">
        <div class="chat-panel-header">
            <div class="agent-avatar">PH</div>
            <div style="flex: 1;">
                <h4 style="margin: 0; color: white;">Professor Hawkeinstein</h4>
                <p style="margin: 0; font-size: 0.875rem; opacity: 0.9;">Mathematics Expert ‚Ä¢ Here to help with this lesson</p>
            </div>
            <button id="closeChatPanel" class="close-chat-btn" title="Close chat">
                <span>‚úï</span>
            </button>
        </div>

        <div class="chat-messages" id="lessonChat">
            <div class="message agent">
                <div class="message-avatar">PH</div>
                <div class="message-content">
                    <p><strong>Professor Hawkeinstein</strong></p>
                    <p>Welcome to our lesson on quadratic equations! I've reviewed your progress and I know you've been working hard. Feel free to ask me anything about this lesson - I'm here to help you master these concepts.</p>
                    <small style="opacity: 0.7;">Just now</small>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <input type="text" id="lessonChatInput" placeholder="Ask about quadratic equations..." />
            <button class="btn btn-primary" id="lessonSendBtn">Send</button>
        </div>
    </div>

    <!-- Course Viewer -->
    <div class="container-fluid">
        <div class="dashboard">
            <!-- Course Navigation Sidebar -->
            <aside class="sidebar">
                <h3 id="courseTitle">Algebra Fundamentals</h3>
                <div class="difficulty-badge difficulty-beginner">Beginner</div>
                
                <div class="progress-bar-container mt-3">
                    <div class="progress-bar-label">
                        <span>Course Progress</span>
                        <span><strong id="courseProgress">75%</strong></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progressBar"></div>
                    </div>
                </div>

                <h4 class="mt-4">Lessons</h4>
                <ul class="sidebar-menu">
                    <li><a href="#" class="lesson-link active" data-lesson="1">‚úì 1. Introduction to Algebra</a></li>
                    <li><a href="#" class="lesson-link" data-lesson="2">‚úì 2. Variables and Expressions</a></li>
                    <li><a href="#" class="lesson-link" data-lesson="3">‚úì 3. Linear Equations</a></li>
                    <li><a href="#" class="lesson-link" data-lesson="4">‚ñ∂ 4. Quadratic Equations</a></li>
                    <li><a href="#" class="lesson-link" data-lesson="5">üîí 5. Systems of Equations</a></li>
                    <li><a href="#" class="lesson-link" data-lesson="6">üîí 6. Polynomials</a></li>
                </ul>

                <div class="alert alert-info mt-3">
                    <strong>AI Agent Active</strong><br>
                    Professor Hawkeinstein is here to help!
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content">
                <!-- Session Active Alert -->
                <div class="alert alert-info">
                    <strong>üîí Session Active:</strong> Your learning progress is being tracked for this lesson.
                </div>

                <!-- Lesson Header -->
                <div>
                    <h1 id="lessonTitle">Lesson 4: Quadratic Equations</h1>
                    <p id="lessonDescription">Learn how to solve quadratic equations using factoring, completing the square, and the quadratic formula.</p>
                </div>

                <!-- Video Player Section -->
                <section class="mt-4">
                    <h2>üì∫ Video Lesson</h2>
                    <div class="video-container">
                        <div class="video-placeholder">
                            <div>
                                <p>‚ñ∂Ô∏è</p>
                                <p>Multimedia Content Placeholder</p>
                                <p style="font-size: 1rem; margin-top: 1rem;">Video: "Understanding Quadratic Equations"</p>
                                <button class="btn btn-secondary mt-2">Play Video</button>
                            </div>
                        </div>
                    </div>
                    <p class="mt-2"><strong>Duration:</strong> 12:45 | <strong>Status:</strong> Not Started</p>
                </section>

                <!-- Lesson Content -->
                <section class="mt-4">
                    <h2>üìñ Lesson Content</h2>
                    <div style="background: var(--bg-light); padding: 2rem; border-radius: var(--radius-lg); line-height: 1.8;">
                        <h3>What is a Quadratic Equation?</h3>
                        <p>A quadratic equation is a second-order polynomial equation in a single variable x, with a ‚â† 0:</p>
                        <div style="background: white; padding: 1.5rem; border-radius: var(--radius); text-align: center; font-size: 1.3rem; margin: 1rem 0;">
                            <strong>ax¬≤ + bx + c = 0</strong>
                        </div>
                        
                        <h3 class="mt-4">The Quadratic Formula</h3>
                        <p>The quadratic formula provides the solution(s) to any quadratic equation:</p>
                        <div style="background: white; padding: 1.5rem; border-radius: var(--radius); text-align: center; font-size: 1.3rem; margin: 1rem 0;">
                            <strong>x = (-b ¬± ‚àö(b¬≤ - 4ac)) / 2a</strong>
                        </div>

                        <h3 class="mt-4">Example Problem</h3>
                        <p>Solve: 2x¬≤ + 5x - 3 = 0</p>
                        <p><strong>Solution:</strong></p>
                        <ol style="margin-left: 2rem;">
                            <li>Identify a = 2, b = 5, c = -3</li>
                            <li>Calculate the discriminant: b¬≤ - 4ac = 25 - 4(2)(-3) = 25 + 24 = 49</li>
                            <li>Apply the formula: x = (-5 ¬± ‚àö49) / 4 = (-5 ¬± 7) / 4</li>
                            <li>Two solutions: x‚ÇÅ = 2/4 = 0.5 and x‚ÇÇ = -12/4 = -3</li>
                        </ol>
                    </div>
                </section>

                <!-- Practice Problems -->
                <section class="mt-4">
                    <h2>‚úçÔ∏è Practice Problems</h2>
                    <div style="background: var(--bg-light); padding: 2rem; border-radius: var(--radius-lg);">
                        <div style="background: white; padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
                            <h4>Problem 1</h4>
                            <p>Solve using the quadratic formula: x¬≤ - 7x + 10 = 0</p>
                            <textarea style="width: 100%; padding: 1rem; border: 2px solid var(--border-color); border-radius: var(--radius); min-height: 100px; margin-top: 1rem;" placeholder="Show your work here..."></textarea>
                            <button class="btn btn-secondary mt-2">Submit Answer</button>
                        </div>

                        <div style="background: white; padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
                            <h4>Problem 2</h4>
                            <p>Solve using the quadratic formula: 3x¬≤ + 2x - 8 = 0</p>
                            <textarea style="width: 100%; padding: 1rem; border: 2px solid var(--border-color); border-radius: var(--radius); min-height: 100px; margin-top: 1rem;" placeholder="Show your work here..."></textarea>
                            <button class="btn btn-secondary mt-2">Submit Answer</button>
                        </div>

                        <button class="btn btn-primary">Get More Practice Problems</button>
                    </div>
                </section>

                <!-- Lesson Navigation -->
                <div style="display: flex; justify-content: space-between; margin-top: 3rem; padding-top: 2rem; border-top: 2px solid var(--border-color);">
                    <button class="btn btn-outline" id="prevLesson">‚Üê Previous Lesson</button>
                    <button class="btn btn-primary" id="nextLesson">Next Lesson ‚Üí</button>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Check authentication - accept both student and admin
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const adminToken = getAdminSession('token');
        
        console.log('[course_viewer] User:', user);
        console.log('[course_viewer] Admin token:', adminToken ? 'EXISTS' : 'MISSING');
        console.log('[course_viewer] User username:', user.username);
        
        if (!user.username && !adminToken) {
            console.log('[course_viewer] No auth found - redirecting to login');
            window.location.href = 'login.html';
        } else if (user.username) {
            console.log('[course_viewer] Student user found');
            document.getElementById('studentName').textContent = user.name;
        } else if (adminToken) {
            console.log('[course_viewer] Admin token found');
            // Admin viewing course
            document.getElementById('studentName').textContent = 'Admin Preview';
        }

        // Get course ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id') || '1';

        // Simulate course data (would come from PHP API in production)
        const courses = {
            '1': {
                title: 'Algebra Fundamentals',
                difficulty: 'beginner',
                progress: 75
            },
            '3': {
                title: 'Introduction to Physics',
                difficulty: 'beginner',
                progress: 45
            },
            '4': {
                title: 'Creative Writing Workshop',
                difficulty: 'intermediate',
                progress: 30
            }
        };

        const course = courses[courseId] || courses['1'];
        document.getElementById('courseTitle').textContent = course.title;
        document.getElementById('courseProgress').textContent = course.progress + '%';
        document.getElementById('progressBar').style.width = course.progress + '%';

        // Lesson navigation
        document.querySelectorAll('.lesson-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                if (link.textContent.includes('üîí')) {
                    alert('Complete previous lessons to unlock this one!');
                    return;
                }
                document.querySelectorAll('.lesson-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });

        // Lesson chat
        const lessonChat = document.getElementById('lessonChat');
        const lessonChatInput = document.getElementById('lessonChatInput');
        const lessonSendBtn = document.getElementById('lessonSendBtn');

        function addLessonMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'agent'}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = isUser ? 'JD' : 'PH';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            if (!isUser) {
                content.innerHTML = `<p><strong>Professor Hawkeinstein</strong></p><p>${text}</p><small style="opacity: 0.7;">${time}</small>`;
            } else {
                content.innerHTML = `<p>${text}</p><small style="opacity: 0.8;">${time}</small>`;
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            lessonChat.appendChild(messageDiv);
            
            lessonChat.scrollTop = lessonChat.scrollHeight;
        }

        function sendLessonMessage() {
            const text = lessonChatInput.value.trim();
            if (!text) return;
            
            addLessonMessage(text, true);
            lessonChatInput.value = '';
            
            // Simulate contextual agent response
            setTimeout(() => {
                const responses = [
                    "Excellent question about quadratic equations! The discriminant (b¬≤ - 4ac) tells us how many real solutions we have...",
                    "I see you're working through the quadratic formula. Remember to always check your discriminant first!",
                    "That's a common point of confusion. Let me explain it using the example we just covered...",
                    "Great observation! Your understanding of this concept is improving. Let's build on that..."
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addLessonMessage(randomResponse, false);
            }, 1500);

            /* Production: Send to C++ agent with lesson context
            fetch('/api/agent/lesson-chat.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: user.userId,
                    agentId: 1,
                    courseId: courseId,
                    lessonId: 4,
                    message: text,
                    context: 'quadratic_equations'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLessonMessage(data.response, false);
                }
            });
            */
        }

        lessonSendBtn.addEventListener('click', sendLessonMessage);
        lessonChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendLessonMessage();
        });

        // Lesson navigation buttons
        document.getElementById('prevLesson').addEventListener('click', () => {
            alert('Loading previous lesson...');
        });

        document.getElementById('nextLesson').addEventListener('click', () => {
            alert('Loading next lesson...');
        });

        // Track session time
        setInterval(() => {
            console.log('Session tracking: Active');
        }, 5000);

        // Agent Chat Bubble Functionality
        (function() {
            const chatBubble = document.getElementById('agentChatBubble');
            const chatPanel = document.getElementById('agentChatPanel');
            const closeBtn = document.getElementById('closeChatPanel');
            
            // Toggle chat panel
            chatBubble.addEventListener('click', function(e) {
                e.stopPropagation();
                chatPanel.classList.toggle('active');
                
                // Clear unread badge when opening
                if (chatPanel.classList.contains('active')) {
                    const badge = document.getElementById('unreadBadge');
                    badge.style.display = 'none';
                    badge.textContent = '0';
                }
            });
            
            // Close chat panel
            closeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                chatPanel.classList.remove('active');
            });
            
            // Close when clicking outside
            document.addEventListener('click', function(e) {
                if (chatPanel.classList.contains('active') && 
                    !chatPanel.contains(e.target) && 
                    !chatBubble.contains(e.target)) {
                    chatPanel.classList.remove('active');
                }
            });
            
            // Prevent panel clicks from closing
            chatPanel.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Handle ESC key to close
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && chatPanel.classList.contains('active')) {
                    chatPanel.classList.remove('active');
                }
            });
        })();
    </script>
</body>
</html>
