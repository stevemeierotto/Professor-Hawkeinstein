<!DOCTYPE html>
<html lang="en">
<head>
    <script src="auth_storage.js"></script>
    <script src="admin_auth.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Review - Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .review-container {
            max-width: 1400px;
            margin: 2rem auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .review-sidebar {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .review-main {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .content-item-compact {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .content-item-compact:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }

        .content-item-compact.active {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .content-item-compact h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.875rem;
        }

        .review-form {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #e5e7eb;
        }

        .score-input {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .score-slider {
            flex: 1;
        }

        .score-value {
            font-weight: bold;
            min-width: 40px;
        }

        .content-preview {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metadata-item {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 6px;
        }

        .metadata-item label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }

        .metadata-item .value {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="index.html" class="logo">üéì Professor Hawkeinstein's Educational Foundation</a>
            <ul class="nav-links">
                <li><a href="admin_dashboard.html">‚Üê Admin Dashboard</a></li>
                <li><a href="admin_scraper.html">Scraper</a></li>
                <li><a href="#" id="adminName">Admin</a></li>
            </ul>
        </div>
    </nav>

    <div class="review-container">
        <!-- Sidebar with content list -->
        <aside class="review-sidebar">
            <h3 style="margin-top: 0;">Pending Reviews</h3>
            <div style="margin-bottom: 1rem;">
                <select id="filterStatus" style="width: 100%; padding: 0.5rem; border-radius: 6px;">
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="">All Status</option>
                </select>
            </div>
            <div id="contentListSidebar">
                <p style="text-align: center; color: var(--text-light);">Loading...</p>
            </div>
        </aside>

        <!-- Main review area -->
        <main class="review-main">
            <div id="reviewArea">
                <div style="text-align: center; padding: 4rem; color: var(--text-light);">
                    <p style="font-size: 3rem;">üìã</p>
                    <p>Select content from the sidebar to review</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Auth check
        const user = getAdminSession('user' || '{}');
        if (!user.username || (user.role !== 'admin' && user.role !== 'root')) {
            window.location.href = 'login.html';
        }
        document.getElementById('adminName').textContent = user.name;

        let currentContent = null;
        let allContent = [];

        // Load content list
        async function loadContentList(status = 'pending') {
            try {
                const url = status ? 
                    `api/admin/list_scraped_content.php?status=${status}&limit=50` :
                    'api/admin/list_scraped_content.php?limit=50';
                
                const response = await fetch(url, {
                });

                if (response.ok) {
                    allContent = await response.json();
                    displayContentList();
                    
                    // Auto-select first item
                    if (allContent.length > 0) {
                        loadContentDetail(allContent[0].content_id);
                    }
                }
            } catch (error) {
                console.error('Error loading content:', error);
            }
        }

        function displayContentList() {
            const sidebar = document.getElementById('contentListSidebar');
            
            if (allContent.length === 0) {
                sidebar.innerHTML = '<p style="text-align: center; color: var(--text-light);">No content found</p>';
                return;
            }

            sidebar.innerHTML = allContent.map(item => `
                <div class="content-item-compact ${currentContent && currentContent.content_id === item.content_id ? 'active' : ''}" 
                     onclick="loadContentDetail(${item.content_id})">
                    <h4>${item.title || 'Untitled'}</h4>
                    <div style="font-size: 0.75rem; color: var(--text-light);">
                        ${item.grade_level || 'Unspecified'} ‚Ä¢ ${item.subject || 'General'}
                    </div>
                    <span class="status-badge status-${item.review_status}" style="margin-top: 0.5rem; display: inline-block;">
                        ${item.review_status}
                    </span>
                </div>
            `).join('');
        }

        async function loadContentDetail(contentId) {
            try {
                const response = await fetch(`api/admin/get_content.php?id=${contentId}`, {
                });

                if (response.ok) {
                    currentContent = await response.json();
                    displayContentDetail();
                    displayContentList(); // Refresh to update active state
                }
            } catch (error) {
                console.error('Error loading content detail:', error);
            }
        }

        function displayContentDetail() {
            const area = document.getElementById('reviewArea');
            
            if (!area || !currentContent) {
                return; // Element or content doesn't exist, skip
            }
            
            const credibilityPercent = (currentContent.credibility_score * 100).toFixed(0);
            
            area.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; position: relative;">
                    <div>
                        <h2 style="margin: 0 0 0.5rem 0;">${currentContent.title || 'Untitled Content'}</h2>
                        <a href="${currentContent.url}" target="_blank" style="color: var(--primary);">
                            ${currentContent.url}
                        </a>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: start;">
                        <span class="status-badge status-${currentContent.review_status}">
                            ${currentContent.review_status}
                        </span>
                        <button type="button" onclick="deleteContent(${currentContent.content_id})" title="Delete this content" style="background: #dc2626; color: white; border: none; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 1.25rem; display: flex; align-items: center; justify-content: center; padding: 0; transition: background 0.2s;">
                            ‚úï
                        </button>
                    </div>
                </div>

                <!-- Metadata -->
                <div class="metadata-grid" style="margin-top: 1.5rem;">
                    <div class="metadata-item">
                        <label>Credibility Score</label>
                        <div class="value">${credibilityPercent}%</div>
                    </div>
                    <div class="metadata-item">
                        <label>Grade Level</label>
                        <div class="value">${currentContent.grade_level || 'Unspecified'}</div>
                    </div>
                    <div class="metadata-item">
                        <label>Subject Area</label>
                        <div class="value">${currentContent.subject || 'General'}</div>
                    </div>
                    <div class="metadata-item">
                        <label>Scraped Date</label>
                        <div class="value">${new Date(currentContent.scraped_at).toLocaleString()}</div>
                    </div>
                    <div class="metadata-item">
                        <label>Content Length</label>
                        <div class="value">${currentContent.content_text.length} characters</div>
                    </div>
                </div>

                <!-- Content Tabs -->
                <div style="margin-top: 2rem;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; border-bottom: 2px solid #e0e0e0;">
                        <button type="button" class="tab-btn active" data-tab="full-content" onclick="switchTab(event, 'full-content')" style="padding: 0.75rem 1.5rem; background: none; border: none; cursor: pointer; font-weight: 500; border-bottom: 3px solid #2563eb;">
                            üìÑ Full Content
                        </button>
                        <button type="button" class="tab-btn" data-tab="summary" onclick="switchTab(event, 'summary')" style="padding: 0.75rem 1.5rem; background: none; border: none; cursor: pointer; font-weight: 500; border-bottom: 3px solid transparent;">
                            ü§ñ AI Summary
                        </button>
                    </div>

                    <!-- Full Content Tab -->
                    <div id="full-content-tab" class="tab-content" style="display: block;">
                        <div class="content-preview" style="max-height: 600px; overflow-y: auto; padding: 1rem; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <p style="white-space: pre-wrap; font-size: 0.95rem; line-height: 1.6;">${currentContent.content_text}</p>
                        </div>
                    </div>

                    <!-- Summary Tab -->
                    <div id="summary-tab" class="tab-content" style="display: none;">
                        <div id="summaryContainer" style="padding: 1rem; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0;">
                            ${currentContent.content_summary ? `
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                    <div style="flex: 1;">
                                        <p style="white-space: pre-wrap; font-size: 0.95rem; line-height: 1.6;">${currentContent.content_summary}</p>
                                    </div>
                                    <button type="button" onclick="generateSummary()" title="Regenerate summary" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; white-space: nowrap; margin-left: 1rem;">
                                        üîÑ Regenerate
                                    </button>
                                </div>
                            ` : `
                            <div style="text-align: center; padding: 2rem;">
                                <p style="color: #666; margin-bottom: 1rem;">Generate a summary using the Summary Agent:</p>
                                <button type="button" onclick="generateSummary()" id="generateBtn" style="background: #2563eb; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">ü§ñ Generate Summary</button>
                            </div>`}
                        </div>
                    </div>
                </div>

                <!-- Review Form -->
                <form class="review-form" id="reviewForm">
                    <h3 style="margin-top: 0;">Review & Quality Assessment</h3>
                    
                    <div class="form-group">
                        <label>Accuracy Score (0-1)</label>
                        <div class="score-input">
                            <input type="range" min="0" max="1" step="0.05" value="0.75" id="accuracyScore" class="score-slider">
                            <span class="score-value" id="accuracyValue">0.75</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Relevance Score (0-1)</label>
                        <div class="score-input">
                            <input type="range" min="0" max="1" step="0.05" value="0.75" id="relevanceScore" class="score-slider">
                            <span class="score-value" id="relevanceValue">0.75</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Quality Score (0-1)</label>
                        <div class="score-input">
                            <input type="range" min="0" max="1" step="0.05" value="0.75" id="qualityScore" class="score-slider">
                            <span class="score-value" id="qualityValue">0.75</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Strengths</label>
                        <textarea id="strengths" rows="3" placeholder="What is good about this content?"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Weaknesses</label>
                        <textarea id="weaknesses" rows="3" placeholder="What needs improvement?"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Fact Check Notes</label>
                        <textarea id="factCheck" rows="3" placeholder="Specific facts verified or disputed"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Recommendation</label>
                        <select id="recommendation" required style="width: 100%; padding: 0.75rem; border-radius: 6px;">
                            <option value="">Select recommendation...</option>
                            <option value="approve">‚úÖ Approve - Ready for use</option>
                            <option value="reject">‚ùå Reject - Not suitable</option>
                            <option value="revise">‚úèÔ∏è Needs Revision</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            Submit Review
                        </button>
                        <button type="button" class="btn btn-outline" onclick="loadNextContent()">
                            Skip ‚Üí
                        </button>
                    </div>
                </form>
            `;

            // Setup slider listeners
            ['accuracy', 'relevance', 'quality'].forEach(type => {
                const slider = document.getElementById(`${type}Score`);
                const valueDisplay = document.getElementById(`${type}Value`);
                slider.addEventListener('input', (e) => {
                    valueDisplay.textContent = e.target.value;
                });
            });

            // Setup form submission
            document.getElementById('reviewForm').addEventListener('submit', submitReview);
        }

        async function submitReview(e) {
            e.preventDefault();

            const reviewData = {
                content_id: currentContent.content_id,
                accuracy_score: parseFloat(document.getElementById('accuracyScore').value),
                relevance_score: parseFloat(document.getElementById('relevanceScore').value),
                quality_score: parseFloat(document.getElementById('qualityScore').value),
                strengths: document.getElementById('strengths').value,
                weaknesses: document.getElementById('weaknesses').value,
                fact_check_notes: document.getElementById('factCheck').value,
                recommendation: document.getElementById('recommendation').value
            };

            try {
                const response = await fetch('api/admin/review_content.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reviewData)
                });

                if (response.ok) {
                    alert('Review submitted successfully!');
                    loadNextContent();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to submit review'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }

        function loadNextContent() {
            const currentIndex = allContent.findIndex(c => c.content_id === currentContent.content_id);
            if (currentIndex < allContent.length - 1) {
                loadContentDetail(allContent[currentIndex + 1].content_id);
            } else {
                alert('No more content to review');
            }
        }

        function switchTab(e, tabName) {
            e.preventDefault();
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Deactivate all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.borderBottom = '3px solid transparent';
            });
            
            // Show selected tab
            const tabEl = document.getElementById(`${tabName}-tab`);
            if (tabEl) {
                tabEl.style.display = 'block';
            }
            
            // Activate button
            e.target.style.borderBottom = '3px solid #2563eb';
        }

        async function generateSummary() {
            if (!currentContent) {
                alert('No content selected');
                return;
            }

            // Use Summary Agent automatically (agent_id = 2)
            const agentId = 2;

            const summaryContainer = document.getElementById('summaryContainer');
            summaryContainer.innerHTML = `<div style="text-align: center; padding: 2rem;">
                <div style="margin-bottom: 1rem;">‚è≥</div>
                <p style="color: #666; font-weight: 500;">Extracting educational content...</p>
                <p style="color: #999; font-size: 0.85rem; margin-top: 0.5rem;">This may take 60-90 seconds</p>
            </div>`;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 150000); // 150 second timeout
                
                const response = await fetch('api/admin/summarize_content.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_id: currentContent.content_id,
                        agent_id: agentId
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log('Summary response status:', response.status, response.ok);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Summary result:', result);
                    
                    if (result.success && result.summary) {
                        currentContent.content_summary = result.summary;
                        currentContent.cleaned_text = result.extracted_content || result.cleaned_text;
                        
                        // Update summary tab with regenerate button
                        summaryContainer.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <p style="white-space: pre-wrap; font-size: 0.95rem; line-height: 1.6;">${result.summary}</p>
                                </div>
                                <button type="button" onclick="generateSummary()" title="Regenerate summary" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; white-space: nowrap; margin-left: 1rem;">
                                    üîÑ Regenerate
                                </button>
                            </div>
                            <div style="margin-top: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 6px; font-size: 0.85rem;">
                                <strong>Extraction Stats:</strong><br>
                                ‚Ä¢ Original: ${result.original_chars || 0} characters<br>
                                ‚Ä¢ Extracted: ${result.extracted_chars || 0} characters<br>
                                ‚Ä¢ Summary: ${result.summary_chars || 0} characters
                            </div>`;
                        
                        alert('Content extraction completed successfully!');
                    } else {
                        showSummaryError('Extraction returned no content');
                    }

                } else {
                    const error = await response.json().catch(() => ({error: 'Server error'}));
                    console.log('Summary error:', error);
                    showSummaryError(error.error || 'Failed to generate summary');
                }
            } catch (error) {
                console.error('Summary exception:', error);
                if (error.name === 'AbortError') {
                    showSummaryError('Request timed out after 150 seconds. Try with shorter content or check server logs.');
                } else {
                    showSummaryError('Error: ' + error.message);
                }
            }
        }

        function showSummaryError(errorMessage) {
            const summaryContainer = document.getElementById('summaryContainer');
            summaryContainer.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="color: #dc2626; margin-bottom: 1rem; font-weight: 500;">
                        ‚ö†Ô∏è ${errorMessage}
                    </div>
                    <p style="color: #666; margin-bottom: 1.5rem;">The summary generation failed. Try again?</p>
                    <button type="button" onclick="generateSummary()" style="background: #2563eb; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; margin-right: 0.5rem;">
                        üîÑ Retry
                    </button>
                    <button type="button" onclick="skipSummary()" style="background: #e5e7eb; color: #333; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                        Skip
                    </button>
                </div>
            `;
        }

        function skipSummary() {
            const summaryContainer = document.getElementById('summaryContainer');
            summaryContainer.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                    <p>Summary generation was skipped.</p>
                    <button type="button" onclick="resetSummaryUI()" style="background: #2563eb; color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin-top: 1rem;">
                        Try Again
                    </button>
                </div>
            `;
        }

        function resetSummaryUI() {
            const summaryContainer = document.getElementById('summaryContainer');
            summaryContainer.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <p style="color: #666; margin-bottom: 1rem;">Generate a summary using the Summary Agent:</p>
                    <button type="button" onclick="generateSummary()" id="generateBtn" style="background: #2563eb; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">ü§ñ Generate Summary</button>
                </div>
            `;
        }

        async function loadAgentsDropdown() {
            // Removed: Now using Summary Agent automatically (agent_id = 2)
        }

        async function deleteContent(contentId) {
            if (!confirm('Are you sure you want to delete this scraped content? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('api/admin/delete_content.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_id: contentId
                    })
                });

                if (response.ok) {
                    // Silently delete and move to next item
                    currentContent = null;
                    await loadContentList('pending');
                    // If no more content, show empty state
                    if (!allContent || allContent.length === 0) {
                        document.getElementById('reviewArea').innerHTML = '<div style="text-align: center; padding: 4rem; color: var(--text-light);">No content to review. All content has been deleted.</div>';
                    }
                } else {
                    const error = await response.json();
                    console.error('Delete failed:', error);
                    alert('Error: ' + (error.error || 'Failed to delete content'));
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Filter change
        document.getElementById('filterStatus').addEventListener('change', (e) => {
            loadContentList(e.target.value);
        });

        // Initial load
        loadContentList('pending');
    </script>
</body>
</html>
